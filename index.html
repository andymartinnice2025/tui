 <!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TUI Mock ‚Äì In-App Virtual Assistant Call (WebRTC) + Live Transcription + xApp Overlay</title>

  <style>
    :root{
      /* TUI-ish palette (approx) */
      --tui-red:#D81E27;
      --tui-ink:#0B1B3A;
      --tui-ink-2:#1E2A55;
      --tui-muted:#5A6782;
      --tui-bg:#F3F6FB;
      --tui-card:#FFFFFF;
      --tui-line:#E2E8F2;
      --tui-blue:#0C4B9E;
      --tui-blue-2:#0A3E86;
      --tui-soft:#EEF4FF;
      --shadow:0 18px 48px rgba(11,27,58,.14);
      --shadow-soft:0 12px 28px rgba(11,27,58,.10);
      --radius:22px;
      --radius2:28px;
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family:var(--font);
      background:#e9eef8;
      min-height:100vh;
      display:grid;
      place-items:center;
      padding:22px;
      color:var(--tui-ink);
    }

    /* Phone frame */
    .phone{
      width:min(430px, 94vw);
      height:min(900px, 94vh);
      background:#0f1115;
      border-radius:40px;
      padding:14px;
      box-shadow:0 34px 90px rgba(0,0,0,.35);
      position:relative;
    }
    .screen{
      height:100%;
      border-radius:30px;
      overflow:hidden;
      background:var(--tui-bg);
      position:relative;
      display:flex;
      flex-direction:column;
    }

    /* Top app bar */
    .appbar{
      background:#fff;
      border-bottom:1px solid var(--tui-line);
      padding:12px 14px 10px;
    }
    .appbarTop{
      display:grid;
      grid-template-columns: 1fr auto 1fr;
      align-items:center;
      gap:10px;
      margin-bottom:10px;
    }
    .time{
      font-weight:950;
      font-size:12px;
      color:rgba(11,27,58,.70);
    }
    .brand{
      justify-self:center;
      display:flex;
      align-items:center;
      gap:10px;
      font-weight:1000;
      letter-spacing:.2px;
    }
    /* Simple placeholder ‚Äúlogo‚Äù */
    .brandMark{
      width:34px;height:34px;border-radius:999px;
      background: radial-gradient(60% 60% at 30% 25%, rgba(255,255,255,.7), transparent 60%),
                  linear-gradient(135deg, var(--tui-red), #ff6a6f);
      display:grid;place-items:center;
      color:#fff;
      font-weight:1000;
      font-size:14px;
      box-shadow:0 10px 20px rgba(216,30,39,.22);
    }
    .brandText{
      font-size:14px;
      color:rgba(11,27,58,.92);
    }
    .appbarIcons{
      justify-self:end;
      display:flex;
      gap:10px;
      align-items:center;
    }
    .iconBtn{
      width:34px;height:34px;border-radius:12px;
      border:1px solid var(--tui-line);
      background:#fff;
      display:grid;place-items:center;
      cursor:pointer;
      box-shadow:0 8px 18px rgba(11,27,58,.06);
      user-select:none;
      font-size:16px;
      color:rgba(11,27,58,.72);
    }

    /* Category row */
    .cats{
      display:flex;
      gap:14px;
      overflow:auto;
      padding:2px 2px 10px;
      scrollbar-width:none;
    }
    .cats::-webkit-scrollbar{ display:none; }

    .cat{
      min-width:78px;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:8px;
      padding:8px 8px 10px;
      border-radius:18px;
      color:rgba(11,27,58,.72);
      font-weight:950;
      font-size:12px;
      user-select:none;
    }
    .cat .dot{
      width:56px;height:56px;border-radius:999px;
      background: #EAF2FF;
      border:1px solid rgba(12,75,158,.10);
      display:grid;place-items:center;
      font-size:22px;
      color:rgba(12,75,158,.90);
    }
    .cat.active{ color:rgba(11,27,58,.92); }
    .cat.active .dot{
      background: #111a55;
      border-color:#111a55;
      color:#fff;
      box-shadow:0 14px 28px rgba(17,26,85,.18);
    }

    /* Content */
    .content{
      flex:1;
      overflow:auto;
      padding:14px 14px 96px;
    }

    .searchPill{
      width:100%;
      border-radius:999px;
      background:#fff;
      border:2px solid rgba(12,75,158,.65);
      color:rgba(12,75,158,.95);
      font-weight:1000;
      font-size:18px;
      padding:16px 14px;
      display:flex;
      justify-content:center;
      align-items:center;
      gap:10px;
      cursor:pointer;
      box-shadow:0 14px 30px rgba(11,27,58,.10);
      user-select:none;
      margin:8px 0 14px;
    }

    .card{
      background:var(--tui-card);
      border:1px solid var(--tui-line);
      border-radius:var(--radius2);
      box-shadow:var(--shadow-soft);
      overflow:hidden;
    }

    .promoCard{
      border-radius:26px;
      background: linear-gradient(135deg, #DDEBFF, #C7F1F7);
      border:1px solid rgba(12,75,158,.10);
      box-shadow:0 18px 44px rgba(11,27,58,.12);
      overflow:hidden;
    }
    .promoTop{
      display:grid;
      grid-template-columns: 1fr 1fr;
      min-height:160px;
    }
    .promoLeft{
      background:#17155E;
      padding:18px;
      color:#fff;
      display:flex;
      flex-direction:column;
      justify-content:center;
      gap:10px;
    }
    .promoLeft .big{
      font-weight:1100;
      font-size:44px;
      letter-spacing:-.6px;
      line-height:1;
    }
    .promoLeft .small{
      opacity:.9;
      font-weight:900;
      font-size:13px;
      line-height:1.3;
    }
    .promoRight{
      padding:18px;
      display:flex;
      flex-direction:column;
      justify-content:center;
      gap:10px;
      color:rgba(11,27,58,.92);
    }
    .tag{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 12px;
      border-radius:999px;
      background:rgba(255,255,255,.72);
      border:1px solid rgba(11,27,58,.10);
      font-weight:1000;
      width:max-content;
    }
    .promoText{
      font-size:14px;
      font-weight:900;
      color:rgba(11,27,58,.78);
      line-height:1.3;
    }
    .promoBottom{
      padding:16px 18px 18px;
      background:rgba(255,255,255,.70);
      backdrop-filter: blur(10px);
      border-top:1px solid rgba(255,255,255,.7);
    }
    .promoBottom h3{
      margin:0 0 6px;
      font-size:22px;
      font-weight:1100;
      letter-spacing:-.2px;
      color:rgba(11,27,58,.95);
    }
    .promoBottom p{
      margin:0 0 14px;
      font-size:13px;
      font-weight:900;
      color:rgba(11,27,58,.60);
      line-height:1.35;
    }

    .btnRow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:10px;
    }
    .btn{
      appearance:none;
      border:none;
      cursor:pointer;
      border-radius:16px;
      padding:12px 14px;
      font-weight:1000;
      font-size:13px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      user-select:none;
    }
    .btn.primary{
      background: linear-gradient(180deg, var(--tui-blue), var(--tui-blue-2));
      color:#fff;
      box-shadow:0 14px 28px rgba(12,75,158,.22);
    }
    .btn.red{
      background: linear-gradient(180deg, var(--tui-red), #ff5158);
      color:#fff;
      box-shadow:0 14px 28px rgba(216,30,39,.18);
    }
    .btn.ghost{
      background:#fff;
      border:1px solid var(--tui-line);
      color:rgba(11,27,58,.82);
      box-shadow:none;
    }
    .btn:disabled{
      opacity:.55;
      cursor:not-allowed;
      box-shadow:none;
    }

    .sectionRow{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin:16px 2px 10px;
      gap:10px;
    }
    .sectionTitle{
      font-size:14px;
      font-weight:1100;
      color:rgba(11,27,58,.62);
    }
    .pillTag{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 12px;
      border-radius:999px;
      font-size:12px;
      font-weight:1100;
      color:rgba(12,75,158,.95);
      background: rgba(12,75,158,.08);
      border:1px solid rgba(12,75,158,.12);
    }

    /* Booking summary card */
    .bookingCard{
      padding:14px;
      border-radius:26px;
    }
    .bookingTop{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:12px;
      margin-bottom:10px;
    }
    .bookingTitle{
      font-size:16px;
      font-weight:1100;
      margin:0;
      color:rgba(11,27,58,.95);
      line-height:1.2;
    }
    .bookingMeta{
      margin:6px 0 0;
      font-size:12.5px;
      font-weight:950;
      color:rgba(11,27,58,.62);
      line-height:1.35;
    }
    .bookingBadge{
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(22,163,74,.18);
      background: rgba(22,163,74,.10);
      color: rgba(22,101,52,.95);
      font-weight:1100;
      font-size:12px;
      white-space:nowrap;
    }

    .infoGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top:12px;
    }
    .infoTile{
      border:1px solid var(--tui-line);
      border-radius:18px;
      padding:10px 10px;
      background:#fff;
      box-shadow:0 10px 22px rgba(11,27,58,.06);
    }
    .infoTile .k{
      font-size:11.5px;
      font-weight:1100;
      color:rgba(11,27,58,.55);
      margin-bottom:4px;
    }
    .infoTile .v{
      font-size:12.5px;
      font-weight:1100;
      color:rgba(11,27,58,.92);
      line-height:1.25;
    }

    /* ‚ÄúMessage‚Äù style assistant card */
    .msgCard{
      padding:14px;
      border-radius:26px;
    }
    .msgHeader{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:10px;
    }
    .msgHeaderLeft{
      font-size:16px;
      font-weight:1100;
      color: rgba(11,27,58,.92);
    }
    .msgHeaderRight{
      font-size:12px;
      font-weight:1000;
      color: rgba(11,27,58,.55);
    }
    .msgBodyRow{
      display:flex;
      gap:12px;
      align-items:flex-end;
    }
    .avatar{
      width:44px;height:44px;border-radius:16px;
      display:grid;place-items:center;
      font-weight:1100;
      color: rgba(12,75,158,.92);
      background: rgba(12,75,158,.10);
      border:1px solid rgba(12,75,158,.14);
      flex:0 0 auto;
    }
    .bubble{
      flex:1;
      background:#fff;
      border:1px solid var(--tui-line);
      border-radius:22px;
      padding:14px 14px 12px;
      box-shadow:0 10px 25px rgba(11,27,58,.06);
    }
    .bubbleText{
      font-size:13.5px;
      line-height:1.35;
      color: rgba(11,27,58,.82);
      font-weight:900;
    }
    .tip{
      margin-top:12px;
      font-size:12px;
      color: rgba(11,27,58,.55);
      border-top:1px solid rgba(226,232,242,.85);
      padding-top:10px;
      line-height:1.35;
      font-weight:900;
    }

    .userReplyRow{
      margin-top:12px;
      display:flex;
      justify-content:flex-end;
    }
    .userReply{
      max-width:78%;
      background: rgba(12,75,158,.10);
      border:1px solid rgba(12,75,158,.16);
      color: rgba(11,27,58,.86);
      border-radius:20px;
      padding:10px 12px;
      font-weight:1000;
      font-size:13px;
      box-shadow:0 10px 25px rgba(11,27,58,.06);
    }

    /* Bottom nav */
    .nav{
      position:absolute;
      left:0;right:0;bottom:0;
      background: rgba(255,255,255,.92);
      border-top:1px solid var(--tui-line);
      padding:10px 10px 14px;
      display:flex;
      justify-content:space-around;
      z-index:10;
      backdrop-filter: blur(10px);
    }
    .navItem{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:6px;
      font-size:11px;
      font-weight:1100;
      color: rgba(11,27,58,.45);
      min-width:56px;
      user-select:none;
    }
    .navItem .ico{
      width:28px;height:28px;
      display:grid;place-items:center;
      border-radius:12px;
      font-size:16px;
    }
    .navItem.active{ color: var(--tui-blue); }
    .navItem.active .ico{
      background: rgba(12,75,158,.10);
      border:1px solid rgba(12,75,158,.14);
      color: var(--tui-blue);
    }

    /* Overlays */
    .overlay{
      position:absolute;
      inset:0;
      background: rgba(11,27,58,.54);
      display:none;
      z-index:50;
      padding:12px;
    }
    .show{ display:block; }

    .sheet{
      position:absolute;
      left:12px; right:12px;
      top:76px;
      bottom:84px;
      border-radius:26px;
      background:#fff;
      border:1px solid rgba(255,255,255,.65);
      box-shadow: 0 30px 90px rgba(0,0,0,.35);
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }
    .topBar{
      padding:14px;
      border-bottom:1px solid var(--tui-line);
      display:flex;
      justify-content:space-between;
      align-items:center;
      background: rgba(12,75,158,.06);
    }
    .topBar .h{
      font-weight:1100;
      font-size:15px;
      color: rgba(11,27,58,.92);
    }
    .sheetBody{
      padding:12px;
      overflow:auto;
      flex:1;
      display:flex;
      flex-direction:column;
      gap:12px;
      min-height:0;
    }

    .webrtcMount{
      border:1px dashed rgba(12,75,158,.30);
      background: rgba(12,75,158,.05);
      border-radius:18px;
      padding:12px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      font-size:12px;
      color: rgba(11,27,58,.55);
    }
    .pill{
      border:1px solid rgba(226,232,242,.95);
      background:#fff;
      border-radius:999px;
      padding:8px 12px;
      color: rgba(11,27,58,.70);
      font-weight:1100;
      font-size:12px;
      white-space:nowrap;
    }

    /* Transcript */
    #transcriptCard{
      display:flex;
      flex-direction:column;
      height:320px;
      min-height:260px;
      border:1px solid var(--tui-line);
      border-radius:22px;
      padding:12px;
      background:#fff;
      box-shadow:0 12px 28px rgba(11,27,58,.08);
    }
    .transcriptHead{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      margin-bottom:10px;
    }
    .transcriptHead .title{
      font-weight:1100;
      font-size:13px;
      margin:0;
      color:rgba(11,27,58,.90);
    }
    .transcriptList{
      display:flex;
      flex-direction:column;
      gap:8px;
      overflow:auto;
      flex:1;
      padding-right:4px;
      scroll-behavior:smooth;
      min-height:0;
    }
    .tLine{
      max-width:92%;
      border-radius:14px;
      padding:10px 10px;
      font-size:12.5px;
      line-height:1.3;
      border:1px solid rgba(226,232,242,.95);
      background:#fff;
      color: rgba(11,27,58,.80);
      box-shadow:0 8px 18px rgba(11,27,58,.06);
      font-weight:900;
      white-space:pre-wrap;
    }
    .tLine.bot{
      align-self:flex-start;
      background: rgba(12,75,158,.06);
      border-color: rgba(12,75,158,.16);
    }
    .tLine.user{
      align-self:flex-end;
      background: rgba(216,30,39,.08);
      border-color: rgba(216,30,39,.14);
    }
    .tMeta{
      display:block;
      font-size:10.5px;
      opacity:.75;
      margin-top:6px;
      font-weight:1100;
      letter-spacing:.2px;
    }

    /* xApp iframe */
    #xappFrame{
      border:0;
      width:100%;
      height:100%;
    }

    .tuiLogo{
      height:28px;         /* tweak */
      width:auto;
      display:block;
}

    /* Hide Cognigy launcher visually once we use our own controls */
    .hide-cognigy-launcher button[data-testid="cognigy-call-button"]{
      opacity:0 !important;
      pointer-events:none !important;
    }
  </style>
</head>

<body>
  <div class="phone">
    <div class="screen">

      <div class="appbar">
        <div class="appbarTop">
          <div class="time">11:07</div>

          <!-- Update this to an <img> if you have a TUI logo URL -->
          <div class="brand" title="TUI">
            <img class="tuiLogo" src="https://upload.wikimedia.org/wikipedia/commons/b/bb/Tui_logo.png" alt="TUI" />
          </div>

          <div class="appbarIcons">
            <div class="iconBtn" id="btnBell" title="Notifications">üîî</div>
          </div>
        </div>

        <div class="cats" aria-label="Categories">
          <div class="cat active"><div class="dot">üèùÔ∏è</div><div>Holidays</div></div>
          <div class="cat"><div class="dot">‚úàÔ∏è</div><div>Flights</div></div>
          <div class="cat"><div class="dot">üì∑</div><div>Experiences</div></div>
          <div class="cat"><div class="dot">üö¢</div><div>Cruises</div></div>
          <div class="cat"><div class="dot">üè®</div><div>Hotels</div></div>
          <div class="cat"><div class="dot">üß≥</div><div>My TUI</div></div>
        </div>
      </div>

      <div class="content">
        <div class="searchPill" id="btnSearch">Search Holidays</div>

        <div class="promoCard" style="margin-bottom:14px;">
          <div class="promoTop">
            <div class="promoLeft">
              <div style="font-weight:1000; opacity:.9;">Up to</div>
              <div class="big">¬£300</div>
              <div class="small">off in the TUI Sale (mock)</div>
            </div>
            <div class="promoRight">
              <div class="tag">EXTRA SAVINGS</div>
              <div class="promoText">Plus, <b>¬£200</b> off selected holidays with your code</div>
              <div class="promoText" style="opacity:.8;">(Demo content)</div>
            </div>
          </div>
          <div class="promoBottom">
            <h3>Use code EXTRA200 to unlock extra savings</h3>
            <p>Up to ¬£300 off auto-applied. May ‚Äì Oct 2026. Min spend and T&Cs apply. (mock)</p>
            <div class="btnRow" style="margin-top:0;">
              <button class="btn primary" id="btnViewDeals">View deals</button>
              <button class="btn ghost" id="btnBookingsJump">Go to bookings</button>
            </div>
          </div>
        </div>

        <div class="sectionRow">
          <div class="sectionTitle">Upcoming trip</div>
          <div class="pillTag">Signed in ‚Ä¢ Andy Martin</div>
        </div>

        <div class="card bookingCard" id="upcomingCard">
          <div class="bookingTop">
            <div style="min-width:0;">
              <p class="bookingTitle">Cancun, Mexico ‚Ä¢ Family holiday</p>
              <p class="bookingMeta">
                2 Adults, 2 Children ‚Ä¢ 14 nights<br/>
                Hotel: Royalton Riviera Cancun (mock)<br/>
                Dates: 01 Jul 2026 ‚Äì 15 Jul 2026
              </p>
            </div>
            <div class="bookingBadge">Confirmed</div>
          </div>

          <div class="infoGrid">
            <div class="infoTile">
              <div class="k">Booking ref</div>
              <div class="v">TUI-MX-482901</div>
            </div>
            <div class="infoTile">
              <div class="k">Departure</div>
              <div class="v">Manchester (MAN)</div>
            </div>
            <div class="infoTile">
              <div class="k">Board</div>
              <div class="v">All Inclusive</div>
            </div>
            <div class="infoTile">
              <div class="k">Transfers</div>
              <div class="v">Included (mock)</div>
            </div>
          </div>

          <div class="btnRow" style="margin-top:12px;">
            <button class="btn primary" id="btnOpenBookings">View booking</button>
            <button class="btn ghost" id="btnOpenExcursion">View excursion</button>
          </div>
        </div>

        <div class="sectionRow" style="margin-top:16px;">
          <div class="sectionTitle">Need help with your excursion?</div>
          <div class="pillTag">Virtual Assistant</div>
        </div>

        <div class="card msgCard">
          <div class="msgHeader">
            <div class="msgHeaderLeft">Thea</div>
            <div class="msgHeaderRight">Just now</div>
          </div>

          <div class="msgBodyRow">
            <div class="avatar">TH</div>
            <div class="bubble">
              <div class="bubbleText">
                Hi Andy üëã I can help you check or amend your <b>Sea Turtle & Cenote Snorkelling</b> excursion in Cancun.
                Want to <b>change the date</b>, confirm <b>pickup details</b>, or ask a question?
              </div>

              <div class="btnRow">
                <button class="btn primary" id="btnCallNow">üìû Call Thea</button>
                <button class="btn ghost" id="btnQuickFaq">‚ùì Ask a question</button>
                <button class="btn red" id="btnManageXapp">üõ†Ô∏è Manage booking</button>
              </div>

              <div class="tip">
                Tip: ‚ÄúCall Thea‚Äù opens an in-app WebRTC call. Triggers can show ‚ÄúClick Here‚Äù to open xApps.
              </div>
            </div>
          </div>

          <div class="userReplyRow">
            <div class="userReply">I need to change the date for our snorkelling trip.</div>
          </div>
        </div>
      </div>

      <div class="nav">
        <div class="navItem active"><div class="ico">üè†</div><div>Explore</div></div>
        <div class="navItem"><div class="ico">üîé</div><div>Search</div></div>
        <div class="navItem"><div class="ico">üßæ</div><div>Bookings</div></div>
        <div class="navItem"><div class="ico">üë§</div><div>Account</div></div>
      </div>

      <!-- BOOKINGS overlay -->
      <div class="overlay" id="bookingsOverlay" aria-hidden="true">
        <div class="sheet">
          <div class="topBar">
            <div class="h">Your bookings</div>
            <button class="btn ghost" id="btnCloseBookings">‚úï</button>
          </div>

          <div class="sheetBody">
            <div class="card bookingCard" style="box-shadow:none;">
              <div class="bookingTop">
                <div style="min-width:0;">
                  <p class="bookingTitle">Cancun, Mexico ‚Ä¢ Royalton Riviera Cancun</p>
                  <p class="bookingMeta">
                    01 Jul 2026 ‚Äì 15 Jul 2026 ‚Ä¢ 14 nights<br/>
                    2 Adults, 2 Children ‚Ä¢ All Inclusive
                  </p>
                </div>
                <div class="bookingBadge">Confirmed</div>
              </div>

              <div class="infoGrid">
                <div class="infoTile"><div class="k">Holiday ref</div><div class="v">TUI-MX-482901</div></div>
                <div class="infoTile"><div class="k">Resort</div><div class="v">Riviera Maya</div></div>
                <div class="infoTile"><div class="k">Room</div><div class="v">Family Suite (mock)</div></div>
                <div class="infoTile"><div class="k">Transfers</div><div class="v">Shared (mock)</div></div>
              </div>

              <div class="btnRow" style="margin-top:12px;">
                <button class="btn ghost" id="btnBookingsExcursion">View excursion</button>
                <button class="btn primary" id="btnBookingsCall">Call Thea</button>
              </div>
            </div>

            <div class="card bookingCard" style="box-shadow:none;">
              <div class="bookingTop">
                <div style="min-width:0;">
                  <p class="bookingTitle">Booked excursion ‚Ä¢ Sea Turtle & Cenote Snorkelling</p>
                  <p class="bookingMeta">
                    Booking ref: <b>VTR-717201</b> (mock)<br/>
                    Current date: <b>2026-07-01</b> ‚Ä¢ Pickup: <b>Riu Cancun, Hotel lobby</b><br/>
                    Party: 2 Adults, 2 Children
                  </p>
                </div>
                <div class="bookingBadge" style="border-color:rgba(12,75,158,.18); background:rgba(12,75,158,.08); color:rgba(12,75,158,.95);">Confirmed</div>
              </div>

              <div class="btnRow" style="margin-top:12px;">
                <button class="btn red" id="btnBookingsManage">Manage booking</button>
                <button class="btn ghost" id="btnBookingsClose">Close</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- CALL overlay -->
      <div class="overlay" id="callOverlay" aria-hidden="true">
        <div class="sheet">
          <div class="topBar">
            <div class="h">Virtual Assistant Call</div>
            <button class="btn ghost" id="btnCloseCall">‚úï</button>
          </div>

          <div class="sheetBody">
            <div class="webrtcMount">
              <div><b>Cognigy WebRTC</b><br><span style="font-size:11px; font-weight:900;">In-app call controls</span></div>
              <div class="pill" id="webrtcStatus">Idle</div>
            </div>

            <div class="btnRow" style="margin:0;">
              <button class="btn primary" id="btnStartCall" disabled>Start call</button>
              <button class="btn ghost" id="btnEndCall">End call</button>
              <button class="btn ghost" id="btnClearTranscript" title="Clear transcript">Clear</button>
            </div>

            <div id="transcriptCard">
              <div class="transcriptHead">
                <p class="title">Live transcription</p>
                <span class="pill" id="transcriptCount">0 lines</span>
              </div>

              <div class="transcriptList" id="transcriptList" aria-live="polite"></div>

              <div id="xappCtaArea" style="margin-top:10px; display:none;">
                <button class="btn primary" id="btnOpenXapp" disabled>Click Here</button>
              </div>
            </div>

            <div class="card" style="padding:12px; border-radius:22px;">
              <div style="font-weight:1100; font-size:13px; color:rgba(11,27,58,.92);">Demo notes</div>
              <div style="margin-top:6px; font-size:12px; font-weight:900; color:rgba(11,27,58,.60); line-height:1.35;">
                ‚Ä¢ Thea‚Äôs transcript is merged into one bubble per utterance (debounced).<br/>
                ‚Ä¢ Auto-scroll stays pinned to bottom as new text arrives.<br/>
                ‚Ä¢ The bot can trigger xApps by speaking a phrase (see config below).<br/>
                ‚Ä¢ The xApp URL is pulled from ntfy (SSE) and opened in-app.
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- xApp overlay -->
      <div class="overlay" id="xappOverlay" aria-hidden="true">
        <div class="sheet" style="padding:0;">
          <div class="topBar" style="margin:0;">
            <div class="h">Manage your excursion</div>
            <button class="btn ghost" id="btnCloseXapp">‚úï</button>
          </div>

          <div style="flex:1; min-height:0;">
            <iframe
              id="xappFrame"
              sandbox="allow-scripts allow-forms allow-same-origin allow-popups">
            </iframe>
          </div>
        </div>
      </div>

    </div>
  </div>

  <script>
    // =========================================================
    // CONFIG (swap these for your demo)
    // =========================================================

    // WebRTC widget script
    const WIDGET_SRC = "https://static-trial.cognigy.ai/webrtc/webRTCWidget.js";

    // Replace with YOUR demo WebRTC endpoint
    const COGNIGY_WEBRTC_ENDPOINT_URL =
      "PASTE_YOUR_WEBRTC_ENDPOINT_URL_HERE";

    // ===== xApp / ntfy config =====
    const NTFY_TOPIC = "PASTE_YOUR_NTFY_TOPIC_HERE";

    // Trigger phrases (bot speaks these -> UI reveals Click Here)
    const XAPP_TRIGGER_PHRASE_1 =
      "Click here to manage your excursion booking.";
    const XAPP_TRIGGER_PHRASE_2 =
      "Click here to confirm the changes to your booking.";

    const FALLBACK_XAPP_URL = "https://example.com";

    // Latest dynamic xApp info (overwritten by ntfy)
    let latestXappUrl = null;
    let latestXappStep = null;

    // CTA state
    let pendingXappStep = null;
    let lastConsumedXappStep = null;

    // =========================================================
    // Helpers
    // =========================================================
    const byId = (id) => document.getElementById(id);
    const show = (el) => el && el.classList.add("show");
    const hide = (el) => el && el.classList.remove("show");
    const setStatus = (t) => { const el = byId("webrtcStatus"); if (el) el.textContent = t; };

    function isVisible(el){
      if (!el) return false;
      const r = el.getBoundingClientRect();
      return r.width > 0 && r.height > 0 && getComputedStyle(el).visibility !== "hidden";
    }

    // =========================================================
    // xApp UI
    // =========================================================
    function showXappCta(step){
      const area = byId("xappCtaArea");
      if (!area) return;

      pendingXappStep = step;

      if (pendingXappStep !== null && pendingXappStep === lastConsumedXappStep) return;

      area.style.display = "block";
      updateXappCtaButton();
    }

    function hideXappCta(){
      const area = byId("xappCtaArea");
      if (!area) return;
      area.style.display = "none";
    }

    function getUrlForPendingStep(){
      if (pendingXappStep != null) {
        if (latestXappUrl && latestXappStep != null && Number(latestXappStep) === Number(pendingXappStep)) {
          return latestXappUrl;
        }
        return null;
      }
      return latestXappUrl || FALLBACK_XAPP_URL;
    }

    function updateXappCtaButton(){
      const btn = byId("btnOpenXapp");
      if (!btn) return;

      const url = getUrlForPendingStep() || (pendingXappStep == null ? FALLBACK_XAPP_URL : null);

      if (url){
        btn.disabled = false;
        btn.textContent = "Click Here";
      } else {
        btn.disabled = true;
        btn.textContent = "Loading link‚Ä¶";
      }
    }

    function openXappInApp(url){
      const overlay = byId("xappOverlay");
      const frame = byId("xappFrame");
      if (!overlay || !frame) return;

      frame.src = url;
      show(overlay);
    }

    function closeXapp(){
      const frame = byId("xappFrame");
      if (frame) frame.src = "about:blank";
      hide(byId("xappOverlay"));
    }

    // =========================================================
    // NTFY subscribe (SSE)
    // Expects message JSON like: {"type":"xapp","url":"https://...","step":1}
    // =========================================================
    function subscribeToNtfy(){
      const url = `https://ntfy.sh/${NTFY_TOPIC}/sse`;
      const es = new EventSource(url);

      es.onmessage = (ev) => {
        try{
          const envelope = JSON.parse(ev.data);
          const msg = envelope.message;
          if (!msg) return;

          const payload = JSON.parse(msg);
          if (payload?.type !== "xapp") return;

          if (typeof payload.url === "string" && payload.url.trim()){
            latestXappUrl = payload.url.trim();
            latestXappStep = payload.step ?? null;
            updateXappCtaButton();
            console.log("xApp URL updated:", latestXappUrl, "step:", latestXappStep);
          }
        } catch {
          // ignore parse errors
        }
      };

      es.onerror = () => {
        console.warn("ntfy SSE disconnected (will retry)...");
      };

      window.__ntfy = es;
    }

    // =========================================================
    // Transcript (MERGED per utterance + auto-scroll) + Names
    // =========================================================
    const VA_NAME = "Thea";
    const USER_NAME = "Andy Martin";

    // If new chunks arrive within this window, treat them as the same utterance
    const MERGE_GAP_MS = 650;

    let transcriptLines = 0;

    let lastTurn = {
      originator: null,     // "user" | "bot"
      el: null,             // DOM element for last bubble
      text: "",             // merged text so far
      timer: null,          // debounce flush timer
      lastUpdateTs: 0
    };

    function updateTranscriptCount(){
      const el = byId("transcriptCount");
      if (!el) return;
      el.textContent = `${transcriptLines} ${transcriptLines === 1 ? "line" : "lines"}`;
    }

    function isPinnedToBottom(list, thresholdPx = 40){
      const distanceFromBottom = list.scrollHeight - list.scrollTop - list.clientHeight;
      return distanceFromBottom < thresholdPx;
    }

    function scrollTranscriptToBottom(){
      const list = byId("transcriptList");
      if (!list) return;
      requestAnimationFrame(() => {
        list.scrollTop = list.scrollHeight;
      });
    }

    function normalizeChunk(s){
      return String(s || "")
        .replace(/\s+/g, " ")
        .replace(/\s([,.;!?])/g, "$1")
        .trim();
    }

    function finalizeTurn(){
      if (lastTurn.timer) clearTimeout(lastTurn.timer);
      lastTurn.timer = null;
      // hook for future (timestamps, etc.)
    }

    function addTranscriptLine(originator, text){
      const list = byId("transcriptList");
      if (!list) return;

      const who = (originator || "unknown").toLowerCase();
      const chunk = normalizeChunk(text);
      if (!chunk) return;

      const pinned = isPinnedToBottom(list);

      const now = Date.now();
      const withinMergeGap = (now - (lastTurn.lastUpdateTs || 0)) <= MERGE_GAP_MS;

      const isUser = (who === "user");
      const turnKey = isUser ? "user" : "bot";

      const shouldMerge =
        lastTurn.el &&
        lastTurn.originator === turnKey &&
        withinMergeGap;

      if (shouldMerge) {
        const joiner = lastTurn.text ? " " : "";
        lastTurn.text = (lastTurn.text + joiner + chunk).trim();

        const meta = lastTurn.el.querySelector(".tMeta");
        lastTurn.el.textContent = lastTurn.text;
        if (meta) lastTurn.el.appendChild(meta);
      } else {
        const line = document.createElement("div");
        line.className = `tLine ${isUser ? "user" : "bot"}`;
        line.textContent = chunk;

        const meta = document.createElement("span");
        meta.className = "tMeta";
        meta.textContent = isUser ? USER_NAME : VA_NAME;
        line.appendChild(meta);

        list.appendChild(line);
        transcriptLines += 1;
        updateTranscriptCount();

        lastTurn.el = line;
        lastTurn.originator = turnKey;
        lastTurn.text = chunk;
      }

      lastTurn.lastUpdateTs = now;

      if (lastTurn.timer) clearTimeout(lastTurn.timer);
      lastTurn.timer = setTimeout(finalizeTurn, MERGE_GAP_MS);

      if (pinned) scrollTranscriptToBottom();

      // Trigger CTA on merged text (works even if phrase arrives in pieces)
      if (!isUser) {
        const merged = lastTurn.text || chunk;
        if (merged.includes(XAPP_TRIGGER_PHRASE_1)) {
          showXappCta(1);
        } else if (merged.includes(XAPP_TRIGGER_PHRASE_2)) {
          showXappCta(2);
        }
      }
    }

    function clearTranscript(){
      const list = byId("transcriptList");
      if (list) list.innerHTML = "";
      transcriptLines = 0;
      updateTranscriptCount();

      pendingXappStep = null;
      lastConsumedXappStep = null;
      hideXappCta();
      updateXappCtaButton();

      // reset merge state
      if (lastTurn.timer) clearTimeout(lastTurn.timer);
      lastTurn = { originator:null, el:null, text:"", timer:null, lastUpdateTs:0 };
    }

    // =========================================================
    // WebSocket tap: captures SIP INFO frames with JSON _transcription
    // =========================================================
    function installWebSocketTranscriptionTap(){
      if (window.__wsTapInstalled) return;
      window.__wsTapInstalled = true;

      const NativeWebSocket = window.WebSocket;

      window.WebSocket = function(...args){
        const ws = new NativeWebSocket(...args);

        ws.addEventListener("message", (ev) => {
          const data = ev.data;
          if (typeof data !== "string") return;

          if (!data.includes('"_transcription"')) return;

          const splitIndex = data.indexOf("\r\n\r\n");
          if (splitIndex === -1) return;

          const body = data.slice(splitIndex + 4).trim();
          if (!body.startsWith("{")) return;

          try{
            const json = JSON.parse(body);
            const t = json?._transcription;
            if (!t) return;

            const originator = t.originator || "unknown";
            const messages = Array.isArray(t.messages) ? t.messages : [];
            for (const m of messages){
              if (m && typeof m.text === "string" && m.text.trim()){
                addTranscriptLine(originator, m.text.trim());
              }
            }
          } catch {
            // ignore
          }
        });

        return ws;
      };

      window.WebSocket.prototype = NativeWebSocket.prototype;
      window.WebSocket.OPEN = NativeWebSocket.OPEN;
      window.WebSocket.CLOSED = NativeWebSocket.CLOSED;
      window.WebSocket.CLOSING = NativeWebSocket.CLOSING;
      window.WebSocket.CONNECTING = NativeWebSocket.CONNECTING;
    }

    installWebSocketTranscriptionTap();

    // =========================================================
    // Widget loader / init
    // =========================================================
    let widgetScriptLoaded = false;
    let widgetInitialized = false;
    let preloadStarted = false;

    function loadScript(timeoutMs = 12000){
      return new Promise((resolve, reject) => {
        if (widgetScriptLoaded) return resolve("already-loaded");
        widgetScriptLoaded = true;

        const s = document.createElement("script");
        s.src = WIDGET_SRC;
        s.async = true;

        let done = false;
        const ok = (how) => { if (done) return; done = true; resolve(how); };
        const fail = (how) => {
          if (done) return;
          done = true;
          widgetScriptLoaded = false;
          reject(new Error(how));
        };

        const t = setTimeout(() => fail("timeout"), timeoutMs);
        s.onload = () => { clearTimeout(t); ok("onload"); };
        s.onerror = () => { clearTimeout(t); fail("onerror"); };

        document.head.appendChild(s);
      });
    }

    async function initWebRTC(){
      if (widgetInitialized) return true;

      try{
        setStatus("Loading‚Ä¶");
        await loadScript(12000);

        if (typeof window.initWebRTCWidget !== "function") {
          setStatus("Unavailable");
          return false;
        }

        setStatus("Initializing‚Ä¶");
        window.initWebRTCWidget(COGNIGY_WEBRTC_ENDPOINT_URL);

        widgetInitialized = true;
        setStatus("Ready");
        return true;
      } catch {
        setStatus("Load failed");
        return false;
      }
    }

    // =========================================================
    // Start/End button discovery
    // =========================================================
    function findCognigyStartButton(){
      return (
        document.querySelector('button[data-testid="cognigy-call-button"]') ||
        document.querySelector('button[aria-label="Start a call"]') ||
        document.querySelector('.webrtc_widget_content_call_button')
      );
    }

    function findCognigyEndButton(){
      return (
        document.querySelector('button[data-testid*="hang" i]') ||
        document.querySelector('button[data-testid*="end" i]') ||
        document.querySelector('button[aria-label*="hang" i]') ||
        document.querySelector('button[aria-label*="end" i]') ||
        document.querySelector('button[title*="hang" i]') ||
        document.querySelector('button[title*="end" i]') ||
        document.querySelector('button[class*="hang" i]') ||
        document.querySelector('button[class*="end" i]')
      );
    }

    function waitForStartButton(timeoutMs = 10000){
      return new Promise((resolve) => {
        const immediate = findCognigyStartButton();
        if (immediate) return resolve(immediate);

        const obs = new MutationObserver(() => {
          const btn = findCognigyStartButton();
          if (btn) { obs.disconnect(); resolve(btn); }
        });
        obs.observe(document.documentElement, { childList:true, subtree:true });

        setTimeout(() => { obs.disconnect(); resolve(null); }, timeoutMs);
      });
    }

    async function preloadForCallUI(){
      if (preloadStarted) return;
      preloadStarted = true;

      const ok = await initWebRTC();
      if (!ok) return;

      const btn = await waitForStartButton(10000);
      if (btn) {
        byId("btnStartCall").disabled = false;
        document.documentElement.classList.add("hide-cognigy-launcher");
        setStatus("Ready");
      } else {
        setStatus("Not ready");
      }
    }

    function startCallSync(){
      const btn = findCognigyStartButton();
      if (!btn) return false;
      btn.click();
      document.documentElement.classList.add("hide-cognigy-launcher");
      setStatus("Calling‚Ä¶");
      return true;
    }

    async function endCall(){
      try {
        const api = window.webRTCWidget || window.webrtcWidget || null;
        if (api && typeof api.endCall === "function") {
          await api.endCall();
          setStatus("Ended");
          return true;
        }
      } catch {}

      const endBtn = findCognigyEndButton();
      if (endBtn && isVisible(endBtn)) {
        endBtn.click();
        setStatus("Ended");
        return true;
      }

      setStatus("End unavailable");
      return false;
    }

    // =========================================================
    // UI wiring
    // =========================================================
    document.addEventListener("DOMContentLoaded", () => {
      subscribeToNtfy();

      // Main CTAs
      byId("btnCallNow").addEventListener("click", () => {
        show(byId("callOverlay"));
        setStatus("Loading‚Ä¶");
        preloadForCallUI();
      });

      byId("btnQuickFaq").addEventListener("click", () => {
        show(byId("callOverlay"));
        setStatus("Loading‚Ä¶");
        preloadForCallUI();
        addTranscriptLine("bot", "Sure ‚Äî what would you like to know about your excursion?");
      });

      // ‚ÄúManage booking‚Äù ‚Äî opens xApp overlay immediately (uses latest URL if published)
      byId("btnManageXapp").addEventListener("click", () => {
        const url = latestXappUrl || FALLBACK_XAPP_URL;
        openXappInApp(url);
      });

      // Bookings overlay open/close
      const openBookings = () => show(byId("bookingsOverlay"));
      const closeBookings = () => hide(byId("bookingsOverlay"));

      byId("btnOpenBookings").addEventListener("click", openBookings);
      byId("btnBookingsJump").addEventListener("click", openBookings);
      byId("btnCloseBookings").addEventListener("click", closeBookings);
      byId("btnBookingsClose").addEventListener("click", closeBookings);

      byId("btnOpenExcursion").addEventListener("click", openBookings);

      byId("btnBookingsExcursion").addEventListener("click", () => {
        closeBookings();
        addTranscriptLine("bot", "I can help you change the date, confirm pickup, or check fees. Would you like to call?");
      });

      byId("btnBookingsCall").addEventListener("click", () => {
        closeBookings();
        show(byId("callOverlay"));
        setStatus("Loading‚Ä¶");
        preloadForCallUI();
      });

      byId("btnBookingsManage").addEventListener("click", () => {
        closeBookings();
        const url = latestXappUrl || FALLBACK_XAPP_URL;
        openXappInApp(url);
      });

      // Close call overlay
      byId("btnCloseCall").addEventListener("click", () => hide(byId("callOverlay")));
      byId("callOverlay").addEventListener("click", (e) => {
        if (e.target === byId("callOverlay")) hide(byId("callOverlay"));
      });

      // Call controls
      byId("btnStartCall").addEventListener("click", () => {
        const ok = startCallSync();
        if (!ok) setStatus("Not ready");
      });

      byId("btnEndCall").addEventListener("click", async () => {
        setStatus("Ending‚Ä¶");
        await endCall();
      });

      // Transcript controls
      byId("btnClearTranscript").addEventListener("click", () => clearTranscript());

      // xApp CTA click: hide immediately + mark consumed
      byId("btnOpenXapp").addEventListener("click", () => {
        const url = getUrlForPendingStep() || (pendingXappStep == null ? FALLBACK_XAPP_URL : null);
        if (!url) return;

        if (pendingXappStep !== null) lastConsumedXappStep = pendingXappStep;

        hideXappCta();
        updateXappCtaButton();
        openXappInApp(url);
      });

      // xApp overlay close
      byId("btnCloseXapp").addEventListener("click", () => closeXapp());
      byId("xappOverlay").addEventListener("click", (e) => {
        if (e.target === byId("xappOverlay")) closeXapp();
      });

      // Cosmetic buttons
      byId("btnSearch").addEventListener("click", openBookings);
      byId("btnViewDeals").addEventListener("click", () => alert("Demo: deals screen not implemented in this mock."));

      setStatus("Idle");
      updateTranscriptCount();
      updateXappCtaButton();
    });
  </script>
</body>
</html>
