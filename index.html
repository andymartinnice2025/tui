<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TUI Mock ‚Äì WebRTC Call + Merged Transcription + xApp Overlay</title>

  <style>
    :root{
      --tui-red:#D81E27;
      --tui-ink:#0B1B3A;
      --tui-muted:#5A6782;
      --tui-bg:#F3F6FB;
      --tui-card:#FFFFFF;
      --tui-line:#E2E8F2;
      --tui-blue:#0C4B9E;
      --tui-blue-2:#0A3E86;
      --shadow:0 18px 48px rgba(11,27,58,.14);
      --shadow-soft:0 12px 28px rgba(11,27,58,.10);
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family:var(--font);
      background:#e9eef8;
      min-height:100vh;
      display:grid;
      place-items:center;
      padding:22px;
      color:var(--tui-ink);
    }

    /* Phone frame */
    .phone{
      width:min(430px, 94vw);
      height:min(900px, 94vh);
      background:#0f1115;
      border-radius:40px;
      padding:14px;
      box-shadow:0 34px 90px rgba(0,0,0,.35);
      position:relative;
    }
    .screen{
      height:100%;
      border-radius:30px;
      overflow:hidden;
      background:var(--tui-bg);
      position:relative;
      display:flex;
      flex-direction:column;
    }

    /* Top app bar */
    .appbar{
      background:#fff;
      border-bottom:1px solid var(--tui-line);
      padding:12px 14px 10px;
    }
    .appbarTop{
      display:grid;
      grid-template-columns: 1fr auto 1fr;
      align-items:center;
      gap:10px;
      margin-bottom:10px;
    }
    .time{
      font-weight:950;
      font-size:12px;
      color:rgba(11,27,58,.70);
    }

    /* ‚úÖ Logo (as requested) */
    .brand{
      justify-self:center;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .tuiLogo{
      height:28px;         /* tweak */
      width:auto;
      display:block;
    }

    .appbarIcons{
      justify-self:end;
      display:flex;
      gap:10px;
      align-items:center;
    }
    .iconBtn{
      width:34px;height:34px;border-radius:12px;
      border:1px solid var(--tui-line);
      background:#fff;
      display:grid;place-items:center;
      cursor:pointer;
      box-shadow:0 8px 18px rgba(11,27,58,.06);
      user-select:none;
      font-size:16px;
      color:rgba(11,27,58,.72);
    }

    /* Category row */
    .cats{
      display:flex;
      gap:14px;
      overflow:auto;
      padding:2px 2px 10px;
      scrollbar-width:none;
    }
    .cats::-webkit-scrollbar{ display:none; }
    .cat{
      min-width:78px;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:8px;
      padding:8px 8px 10px;
      border-radius:18px;
      color:rgba(11,27,58,.72);
      font-weight:950;
      font-size:12px;
      user-select:none;
    }
    .cat .dot{
      width:56px;height:56px;border-radius:999px;
      background: #EAF2FF;
      border:1px solid rgba(12,75,158,.10);
      display:grid;place-items:center;
      font-size:22px;
      color:rgba(12,75,158,.90);
    }
    .cat.active{ color:rgba(11,27,58,.92); }
    .cat.active .dot{
      background: #111a55;
      border-color:#111a55;
      color:#fff;
      box-shadow:0 14px 28px rgba(17,26,85,.18);
    }

    /* Content */
    .content{
      flex:1;
      overflow:auto;
      padding:14px 14px 96px;
    }

    .sectionRow{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin:14px 2px 10px;
      gap:10px;
    }
    .sectionTitle{
      font-size:14px;
      font-weight:1100;
      color:rgba(11,27,58,.62);
    }
    .pillTag{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 12px;
      border-radius:999px;
      font-size:12px;
      font-weight:1100;
      color:rgba(12,75,158,.95);
      background: rgba(12,75,158,.08);
      border:1px solid rgba(12,75,158,.12);
    }

    .card{
      background:var(--tui-card);
      border:1px solid var(--tui-line);
      border-radius:28px;
      box-shadow:var(--shadow-soft);
      overflow:hidden;
      padding:14px;
    }

    .msgHeader{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:10px;
    }
    .msgHeaderLeft{
      font-size:16px;
      font-weight:1100;
      color: rgba(11,27,58,.92);
    }
    .msgHeaderRight{
      font-size:12px;
      font-weight:1000;
      color: rgba(11,27,58,.55);
    }
    .msgBodyRow{
      display:flex;
      gap:12px;
      align-items:flex-end;
    }
    .avatar{
      width:44px;height:44px;border-radius:16px;
      display:grid;place-items:center;
      font-weight:1100;
      color: rgba(12,75,158,.92);
      background: rgba(12,75,158,.10);
      border:1px solid rgba(12,75,158,.14);
      flex:0 0 auto;
    }
    .bubble{
      flex:1;
      background:#fff;
      border:1px solid var(--tui-line);
      border-radius:22px;
      padding:14px 14px 12px;
      box-shadow:0 10px 25px rgba(11,27,58,.06);
    }
    .bubbleText{
      font-size:13.5px;
      line-height:1.35;
      color: rgba(11,27,58,.82);
      font-weight:900;
    }
    .tip{
      margin-top:12px;
      font-size:12px;
      color: rgba(11,27,58,.55);
      border-top:1px solid rgba(226,232,242,.85);
      padding-top:10px;
      line-height:1.35;
      font-weight:900;
    }

    .btnRow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:12px;
    }
    .btn{
      appearance:none;
      border:none;
      cursor:pointer;
      border-radius:16px;
      padding:12px 14px;
      font-weight:1000;
      font-size:13px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      user-select:none;
    }
    .btn.primary{
      background: linear-gradient(180deg, var(--tui-blue), var(--tui-blue-2));
      color:#fff;
      box-shadow:0 14px 28px rgba(12,75,158,.22);
    }
    .btn.ghost{
      background:#fff;
      border:1px solid var(--tui-line);
      color:rgba(11,27,58,.82);
      box-shadow:none;
    }
    .btn:disabled{
      opacity:.55;
      cursor:not-allowed;
      box-shadow:none;
    }

    /* Bottom nav */
    .nav{
      position:absolute;
      left:0;right:0;bottom:0;
      background: rgba(255,255,255,.92);
      border-top:1px solid var(--tui-line);
      padding:10px 10px 14px;
      display:flex;
      justify-content:space-around;
      z-index:10;
      backdrop-filter: blur(10px);
    }
    .navItem{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:6px;
      font-size:11px;
      font-weight:1100;
      color: rgba(11,27,58,.45);
      min-width:56px;
      user-select:none;
    }
    .navItem .ico{
      width:28px;height:28px;
      display:grid;place-items:center;
      border-radius:12px;
      font-size:16px;
    }
    .navItem.active{ color: var(--tui-blue); }
    .navItem.active .ico{
      background: rgba(12,75,158,.10);
      border:1px solid rgba(12,75,158,.14);
      color: var(--tui-blue);
    }

    /* Overlays */
    .overlay{
      position:absolute;
      inset:0;
      background: rgba(11,27,58,.54);
      display:none;
      z-index:50;
      padding:12px;
    }
    .show{ display:block; }

    .sheet{
      position:absolute;
      left:12px; right:12px;
      top:76px;
      bottom:84px;
      border-radius:26px;
      background:#fff;
      border:1px solid rgba(255,255,255,.65);
      box-shadow: 0 30px 90px rgba(0,0,0,.35);
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }
    .topBar{
      padding:14px;
      border-bottom:1px solid var(--tui-line);
      display:flex;
      justify-content:space-between;
      align-items:center;
      background: rgba(12,75,158,.06);
    }
    .topBar .h{
      font-weight:1100;
      font-size:15px;
      color: rgba(11,27,58,.92);
    }
    .sheetBody{
      padding:12px;
      overflow:auto;
      flex:1;
      display:flex;
      flex-direction:column;
      gap:12px;
      min-height:0;
    }

    .webrtcMount{
      border:1px dashed rgba(12,75,158,.30);
      background: rgba(12,75,158,.05);
      border-radius:18px;
      padding:12px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      font-size:12px;
      color: rgba(11,27,58,.55);
    }
    .pill{
      border:1px solid rgba(226,232,242,.95);
      background:#fff;
      border-radius:999px;
      padding:8px 12px;
      color: rgba(11,27,58,.70);
      font-weight:1100;
      font-size:12px;
      white-space:nowrap;
    }

    /* Transcript */
    #transcriptCard{
      display:flex;
      flex-direction:column;
      height:340px;
      min-height:280px;
      border:1px solid var(--tui-line);
      border-radius:22px;
      padding:12px;
      background:#fff;
      box-shadow:0 12px 28px rgba(11,27,58,.08);
    }
    .transcriptHead{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      margin-bottom:10px;
    }
    .transcriptHead .title{
      font-weight:1100;
      font-size:13px;
      margin:0;
      color:rgba(11,27,58,.90);
    }
    .transcriptList{
      display:flex;
      flex-direction:column;
      gap:8px;
      overflow:auto;
      flex:1;
      padding-right:4px;
      scroll-behavior:smooth;
      min-height:0;
    }
    .tLine{
      max-width:92%;
      border-radius:14px;
      padding:10px 10px;
      font-size:12.5px;
      line-height:1.3;
      border:1px solid rgba(226,232,242,.95);
      background:#fff;
      color: rgba(11,27,58,.80);
      box-shadow:0 8px 18px rgba(11,27,58,.06);
      font-weight:900;
      white-space:pre-wrap;
    }
    .tLine.bot{
      align-self:flex-start;
      background: rgba(12,75,158,.06);
      border-color: rgba(12,75,158,.16);
    }
    .tLine.user{
      align-self:flex-end;
      background: rgba(216,30,39,.08);
      border-color: rgba(216,30,39,.14);
    }
    .tMeta{
      display:block;
      font-size:10.5px;
      opacity:.75;
      margin-top:6px;
      font-weight:1100;
      letter-spacing:.2px;
    }

    /* xApp iframe */
    #xappFrame{
      border:0;
      width:100%;
      height:100%;
    }

    /* Hide Cognigy launcher visually once we use our own controls */
    .hide-cognigy-launcher button[data-testid="cognigy-call-button"]{
      opacity:0 !important;
      pointer-events:none !important;
    }
  </style>
</head>

<body>
  <div class="phone">
    <div class="screen">

      <div class="appbar">
        <div class="appbarTop">
          <div class="time">11:07</div>

          <!-- ‚úÖ TUI Logo -->
          <div class="brand" title="TUI">
            <img class="tuiLogo" src="https://upload.wikimedia.org/wikipedia/commons/b/bb/Tui_logo.png" alt="TUI" />
          </div>

          <div class="appbarIcons">
            <div class="iconBtn" title="Notifications">üîî</div>
          </div>
        </div>

        <div class="cats" aria-label="Categories">
          <div class="cat active"><div class="dot">üèùÔ∏è</div><div>Holidays</div></div>
          <div class="cat"><div class="dot">‚úàÔ∏è</div><div>Flights</div></div>
          <div class="cat"><div class="dot">üì∑</div><div>Experiences</div></div>
          <div class="cat"><div class="dot">üö¢</div><div>Cruises</div></div>
          <div class="cat"><div class="dot">üè®</div><div>Hotels</div></div>
          <div class="cat"><div class="dot">üß≥</div><div>My TUI</div></div>
        </div>
      </div>

      <div class="content">
        <div class="sectionRow">
          <div class="sectionTitle">Need help with your excursion?</div>
          <div class="pillTag">Signed in ‚Ä¢ Andy Martin</div>
        </div>

        <div class="card">
          <div class="msgHeader">
            <div class="msgHeaderLeft">Thea</div>
            <div class="msgHeaderRight">Just now</div>
          </div>

          <div class="msgBodyRow">
            <div class="avatar">TH</div>
            <div class="bubble">
              <div class="bubbleText">
                Hi Andy üëã I can help you check or amend your <b>Sea Turtle &amp; Cenote Snorkelling</b> excursion in Cancun.
                Want to <b>change the date</b>, confirm <b>pickup details</b>, or ask a question?
              </div>

              <div class="btnRow">
                <button class="btn primary" id="btnCallNow">üìû Call Thea</button>
                <button class="btn ghost" id="btnOpenCall">Open call panel</button>
              </div>

              <div class="tip">
                WebRTC is preloaded on page load (NatWest-style) and the ‚ÄúStart call‚Äù button enables once ready.
                Thea‚Äôs transcript is merged into one bubble per utterance.
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="nav">
        <div class="navItem active"><div class="ico">üè†</div><div>Explore</div></div>
        <div class="navItem"><div class="ico">üîé</div><div>Search</div></div>
        <div class="navItem"><div class="ico">üßæ</div><div>Bookings</div></div>
        <div class="navItem"><div class="ico">üë§</div><div>Account</div></div>
      </div>

      <!-- CALL overlay -->
      <div class="overlay" id="callOverlay" aria-hidden="true">
        <div class="sheet">
          <div class="topBar">
            <div class="h">Virtual Assistant Call</div>
            <button class="btn ghost" id="btnCloseCall">‚úï</button>
          </div>

          <div class="sheetBody">
            <div class="webrtcMount">
              <div><b>Cognigy WebRTC</b><br><span style="font-size:11px; font-weight:900;">In-app call controls</span></div>
              <div class="pill" id="webrtcStatus">Idle</div>
            </div>

            <div class="btnRow" style="margin:0;">
              <button class="btn primary" id="btnStartCall" disabled>Start call</button>
              <button class="btn ghost" id="btnEndCall">End call</button>
              <button class="btn ghost" id="btnClearTranscript" title="Clear transcript">Clear</button>
            </div>

            <div id="transcriptCard">
              <div class="transcriptHead">
                <p class="title">Live transcription</p>
                <span class="pill" id="transcriptCount">0 lines</span>
              </div>

              <div class="transcriptList" id="transcriptList" aria-live="polite"></div>

              <div id="xappCtaArea" style="margin-top:10px; display:none;">
                <button class="btn primary" id="btnOpenXapp" disabled>Click Here</button>
              </div>
            </div>

            <div class="card" style="padding:12px; border-radius:22px;">
              <div style="font-weight:1100; font-size:13px; color:rgba(11,27,58,.92);">Status</div>
              <div style="margin-top:6px; font-size:12px; font-weight:900; color:rgba(11,27,58,.60); line-height:1.35;">
                ‚Ä¢ WebRTC preloads on page load.<br/>
                ‚Ä¢ ‚ÄúStart call‚Äù enables when the Cognigy call button is detected.<br/>
                ‚Ä¢ Thea‚Äôs transcript is merged into one box per utterance (debounced).<br/>
                ‚Ä¢ Auto-scroll stays pinned to bottom as text arrives.
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- xApp overlay -->
      <div class="overlay" id="xappOverlay" aria-hidden="true">
        <div class="sheet" style="padding:0;">
          <div class="topBar" style="margin:0;">
            <div class="h">Your options</div>
            <button class="btn ghost" id="btnCloseXapp">‚úï</button>
          </div>

          <div style="flex:1; min-height:0;">
            <iframe
              id="xappFrame"
              sandbox="allow-scripts allow-forms allow-same-origin allow-popups">
            </iframe>
          </div>
        </div>
      </div>

    </div>
  </div>

  <script>
    // =========================================================
    // CONFIG (NatWest-style preload)
    // =========================================================
    const WIDGET_SRC = "https://static-trial.cognigy.ai/webrtc/webRTCWidget.js";

    const COGNIGY_WEBRTC_ENDPOINT_URL =
      "https://endpoint-trial.cognigy.ai/1ef4612c505f7f3d8ac3d4cc2bc0367bc702656498828b1c463ebcf466772406";

    // (xApp bits left here for future, not required for WebRTC)
    const NTFY_TOPIC = "tui-xapp-demo-topic"; // change later
    const XAPP_TRIGGER_PHRASE_1 = "Click here to manage your excursion booking.";
    const XAPP_TRIGGER_PHRASE_2 = "Click here to confirm the changes to your booking.";
    const FALLBACK_XAPP_URL = "https://example.com";

    let latestXappUrl = null;
    let latestXappStep = null;
    let pendingXappStep = null;
    let lastConsumedXappStep = null;

    // =========================================================
    // Helpers
    // =========================================================
    const byId = (id) => document.getElementById(id);
    const show = (el) => el && el.classList.add("show");
    const hide = (el) => el && el.classList.remove("show");
    const setStatus = (t) => { const el = byId("webrtcStatus"); if (el) el.textContent = t; };

    function isVisible(el){
      if (!el) return false;
      const r = el.getBoundingClientRect();
      return r.width > 0 && r.height > 0 && getComputedStyle(el).visibility !== "hidden";
    }

    // =========================================================
    // xApp UI (kept for later use)
    // =========================================================
    function showXappCta(step){
      const area = byId("xappCtaArea");
      if (!area) return;

      pendingXappStep = step;

      if (pendingXappStep !== null && pendingXappStep === lastConsumedXappStep) return;

      area.style.display = "block";
      updateXappCtaButton();
    }
    function hideXappCta(){
      const area = byId("xappCtaArea");
      if (!area) return;
      area.style.display = "none";
    }
    function getUrlForPendingStep(){
      if (pendingXappStep != null) {
        if (latestXappUrl && latestXappStep != null && Number(latestXappStep) === Number(pendingXappStep)) {
          return latestXappUrl;
        }
        return null;
      }
      return latestXappUrl || FALLBACK_XAPP_URL;
    }
    function updateXappCtaButton(){
      const btn = byId("btnOpenXapp");
      if (!btn) return;

      const url = getUrlForPendingStep() || (pendingXappStep == null ? FALLBACK_XAPP_URL : null);
      if (url){
        btn.disabled = false;
        btn.textContent = "Click Here";
      } else {
        btn.disabled = true;
        btn.textContent = "Loading link‚Ä¶";
      }
    }
    function openXappInApp(url){
      const overlay = byId("xappOverlay");
      const frame = byId("xappFrame");
      if (!overlay || !frame) return;
      frame.src = url;
      show(overlay);
    }
    function closeXapp(){
      const frame = byId("xappFrame");
      if (frame) frame.src = "about:blank";
      hide(byId("xappOverlay"));
    }

    // Optional: ntfy subscription (safe if unused)
    function subscribeToNtfy(){
      if (!NTFY_TOPIC) return;
      const url = `https://ntfy.sh/${NTFY_TOPIC}/sse`;
      try{
        const es = new EventSource(url);
        es.onmessage = (ev) => {
          try{
            const envelope = JSON.parse(ev.data);
            const msg = envelope.message;
            if (!msg) return;
            const payload = JSON.parse(msg);
            if (payload?.type !== "xapp") return;
            if (typeof payload.url === "string" && payload.url.trim()){
              latestXappUrl = payload.url.trim();
              latestXappStep = payload.step ?? null;
              updateXappCtaButton();
            }
          } catch {}
        };
        window.__ntfy = es;
      } catch {}
    }

    // =========================================================
    // Transcript (MERGE Thea chunks into one bubble per utterance)
    // =========================================================
    const VA_NAME = "Thea";
    const USER_NAME = "Andy Martin";
    const MERGE_GAP_MS = 650;

    let transcriptLines = 0;
    let lastTurn = {
      originator: null,     // "user" | "bot"
      el: null,
      text: "",
      timer: null,
      lastUpdateTs: 0
    };

    function updateTranscriptCount(){
      const el = byId("transcriptCount");
      if (!el) return;
      el.textContent = `${transcriptLines} ${transcriptLines === 1 ? "line" : "lines"}`;
    }

    function isPinnedToBottom(list, thresholdPx = 40){
      const distanceFromBottom = list.scrollHeight - list.scrollTop - list.clientHeight;
      return distanceFromBottom < thresholdPx;
    }

    function scrollTranscriptToBottom(){
      const list = byId("transcriptList");
      if (!list) return;
      requestAnimationFrame(() => {
        list.scrollTop = list.scrollHeight;
      });
    }

    function normalizeChunk(s){
      return String(s || "")
        .replace(/\s+/g, " ")
        .replace(/\s([,.;!?])/g, "$1")
        .trim();
    }

    function finalizeTurn(){
      if (lastTurn.timer) clearTimeout(lastTurn.timer);
      lastTurn.timer = null;
    }

    function addTranscriptLine(originator, text){
      const list = byId("transcriptList");
      if (!list) return;

      const who = (originator || "unknown").toLowerCase();
      const chunk = normalizeChunk(text);
      if (!chunk) return;

      const pinned = isPinnedToBottom(list);

      const now = Date.now();
      const withinMergeGap = (now - (lastTurn.lastUpdateTs || 0)) <= MERGE_GAP_MS;

      const isUser = (who === "user");
      const turnKey = isUser ? "user" : "bot";

      const shouldMerge =
        lastTurn.el &&
        lastTurn.originator === turnKey &&
        withinMergeGap;

      if (shouldMerge) {
        const joiner = lastTurn.text ? " " : "";
        lastTurn.text = (lastTurn.text + joiner + chunk).trim();

        const meta = lastTurn.el.querySelector(".tMeta");
        lastTurn.el.textContent = lastTurn.text;
        if (meta) lastTurn.el.appendChild(meta);
      } else {
        const line = document.createElement("div");
        line.className = `tLine ${isUser ? "user" : "bot"}`;
        line.textContent = chunk;

        const meta = document.createElement("span");
        meta.className = "tMeta";
        meta.textContent = isUser ? USER_NAME : VA_NAME;
        line.appendChild(meta);

        list.appendChild(line);
        transcriptLines += 1;
        updateTranscriptCount();

        lastTurn.el = line;
        lastTurn.originator = turnKey;
        lastTurn.text = chunk;
      }

      lastTurn.lastUpdateTs = now;

      if (lastTurn.timer) clearTimeout(lastTurn.timer);
      lastTurn.timer = setTimeout(finalizeTurn, MERGE_GAP_MS);

      if (pinned) scrollTranscriptToBottom();

      // xApp trigger detection on merged text
      if (!isUser) {
        const merged = lastTurn.text || chunk;
        if (merged.includes(XAPP_TRIGGER_PHRASE_1)) {
          showXappCta(1);
        } else if (merged.includes(XAPP_TRIGGER_PHRASE_2)) {
          showXappCta(2);
        }
      }
    }

    function clearTranscript(){
      const list = byId("transcriptList");
      if (list) list.innerHTML = "";
      transcriptLines = 0;
      updateTranscriptCount();

      pendingXappStep = null;
      lastConsumedXappStep = null;
      hideXappCta();
      updateXappCtaButton();

      if (lastTurn.timer) clearTimeout(lastTurn.timer);
      lastTurn = { originator:null, el:null, text:"", timer:null, lastUpdateTs:0 };
    }

    // =========================================================
    // WebSocket tap: captures SIP INFO frames with JSON _transcription
    // =========================================================
    function installWebSocketTranscriptionTap(){
      if (window.__wsTapInstalled) return;
      window.__wsTapInstalled = true;

      const NativeWebSocket = window.WebSocket;

      window.WebSocket = function(...args){
        const ws = new NativeWebSocket(...args);

        ws.addEventListener("message", (ev) => {
          const data = ev.data;
          if (typeof data !== "string") return;
          if (!data.includes('"_transcription"')) return;

          const splitIndex = data.indexOf("\r\n\r\n");
          if (splitIndex === -1) return;

          const body = data.slice(splitIndex + 4).trim();
          if (!body.startsWith("{")) return;

          try{
            const json = JSON.parse(body);
            const t = json?._transcription;
            if (!t) return;

            const originator = t.originator || "unknown";
            const messages = Array.isArray(t.messages) ? t.messages : [];
            for (const m of messages){
              if (m && typeof m.text === "string" && m.text.trim()){
                addTranscriptLine(originator, m.text.trim());
              }
            }
          } catch {
            // ignore
          }
        });

        return ws;
      };

      window.WebSocket.prototype = NativeWebSocket.prototype;
      window.WebSocket.OPEN = NativeWebSocket.OPEN;
      window.WebSocket.CLOSED = NativeWebSocket.CLOSED;
      window.WebSocket.CLOSING = NativeWebSocket.CLOSING;
      window.WebSocket.CONNECTING = NativeWebSocket.CONNECTING;
    }

    installWebSocketTranscriptionTap();

    // =========================================================
    // Widget loader / init (NatWest-style preload)
    // =========================================================
    let widgetScriptLoaded = false;
    let widgetInitialized = false;
    let preloadStarted = false;

    function loadScript(timeoutMs = 12000){
      return new Promise((resolve, reject) => {
        if (widgetScriptLoaded) return resolve("already-loaded");
        widgetScriptLoaded = true;

        const s = document.createElement("script");
        s.src = WIDGET_SRC;
        s.async = true;

        let done = false;
        const ok = (how) => { if (done) return; done = true; resolve(how); };
        const fail = (how) => {
          if (done) return;
          done = true;
          widgetScriptLoaded = false;
          reject(new Error(how));
        };

        const t = setTimeout(() => fail("timeout"), timeoutMs);
        s.onload = () => { clearTimeout(t); ok("onload"); };
        s.onerror = () => { clearTimeout(t); fail("onerror"); };

        document.head.appendChild(s);
      });
    }

    async function initWebRTC(){
      if (widgetInitialized) return true;

      try{
        setStatus("Loading‚Ä¶");
        await loadScript(12000);

        if (typeof window.initWebRTCWidget !== "function") {
          setStatus("Unavailable");
          return false;
        }

        setStatus("Initializing‚Ä¶");
        window.initWebRTCWidget(COGNIGY_WEBRTC_ENDPOINT_URL);

        widgetInitialized = true;
        setStatus("Ready");
        return true;
      } catch {
        setStatus("Load failed");
        return false;
      }
    }

    // ========= Start/End button discovery (same as NatWest) =========
    function findCognigyStartButton(){
      return (
        document.querySelector('button[data-testid="cognigy-call-button"]') ||
        document.querySelector('button[aria-label="Start a call"]') ||
        document.querySelector('.webrtc_widget_content_call_button')
      );
    }

    function findCognigyEndButton(){
      return (
        document.querySelector('button[data-testid*="hang" i]') ||
        document.querySelector('button[data-testid*="end" i]') ||
        document.querySelector('button[aria-label*="hang" i]') ||
        document.querySelector('button[aria-label*="end" i]') ||
        document.querySelector('button[title*="hang" i]') ||
        document.querySelector('button[title*="end" i]') ||
        document.querySelector('button[class*="hang" i]') ||
        document.querySelector('button[class*="end" i]')
      );
    }

    function waitForStartButton(timeoutMs = 10000){
      return new Promise((resolve) => {
        const immediate = findCognigyStartButton();
        if (immediate) return resolve(immediate);

        const obs = new MutationObserver(() => {
          const btn = findCognigyStartButton();
          if (btn) { obs.disconnect(); resolve(btn); }
        });
        obs.observe(document.documentElement, { childList:true, subtree:true });

        setTimeout(() => { obs.disconnect(); resolve(null); }, timeoutMs);
      });
    }

    async function preloadForCallUI(){
      if (preloadStarted) return;
      preloadStarted = true;

      const ok = await initWebRTC();
      if (!ok) return;

      const btn = await waitForStartButton(10000);
      if (btn) {
        byId("btnStartCall").disabled = false;
        document.documentElement.classList.add("hide-cognigy-launcher");
        setStatus("Ready");
      } else {
        setStatus("Not ready");
      }
    }

    function startCallSync(){
      const btn = findCognigyStartButton();
      if (!btn) return false;
      btn.click();
      document.documentElement.classList.add("hide-cognigy-launcher");
      setStatus("Calling‚Ä¶");
      return true;
    }

    async function endCall(){
      try {
        const api = window.webRTCWidget || window.webrtcWidget || null;
        if (api && typeof api.endCall === "function") {
          await api.endCall();
          setStatus("Ended");
          return true;
        }
      } catch {}

      const endBtn = findCognigyEndButton();
      if (endBtn && isVisible(endBtn)) {
        endBtn.click();
        setStatus("Ended");
        return true;
      }

      setStatus("End unavailable");
      return false;
    }

    // =========================================================
    // UI wiring
    // =========================================================
    document.addEventListener("DOMContentLoaded", () => {
      // Start listening for xApps immediately (optional)
      subscribeToNtfy();

      // ‚úÖ NatWest-style: preload WebRTC on page load
      setStatus("Loading‚Ä¶");
      preloadForCallUI();

      // Open call overlay
      byId("btnOpenCall").addEventListener("click", () => show(byId("callOverlay")));

      // ‚ÄúCall Thea‚Äù opens overlay then you press ‚ÄúStart call‚Äù
      byId("btnCallNow").addEventListener("click", () => {
        show(byId("callOverlay"));
        // If preload failed earlier, attempt again:
        preloadForCallUI();
      });

      byId("btnCloseCall").addEventListener("click", () => hide(byId("callOverlay")));
      byId("callOverlay").addEventListener("click", (e) => {
        if (e.target === byId("callOverlay")) hide(byId("callOverlay"));
      });

      byId("btnStartCall").addEventListener("click", () => {
        const ok = startCallSync();
        if (!ok) setStatus("Not ready");
      });

      byId("btnEndCall").addEventListener("click", async () => {
        setStatus("Ending‚Ä¶");
        await endCall();
      });

      byId("btnClearTranscript").addEventListener("click", () => clearTranscript());

      byId("btnOpenXapp")?.addEventListener("click", () => {
        const url = getUrlForPendingStep() || (pendingXappStep == null ? FALLBACK_XAPP_URL : null);
        if (!url) return;
        if (pendingXappStep !== null) lastConsumedXappStep = pendingXappStep;
        hideXappCta();
        updateXappCtaButton();
        openXappInApp(url);
      });

      byId("btnCloseXapp")?.addEventListener("click", () => closeXapp());
      byId("xappOverlay")?.addEventListener("click", (e) => {
        if (e.target === byId("xappOverlay")) closeXapp();
      });

      // Seed with a sample line (optional)
      // addTranscriptLine("bot", "Hi Andy ‚Äî I can help you change the date or confirm pickup details.");
      updateTranscriptCount();
      updateXappCtaButton();
    });
  </script>
</body>
</html>
