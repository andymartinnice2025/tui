<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TUI Mock ‚Äì Proactive Message ‚Üí WebRTC Call + Merged Transcription + xApp</title>

  <style>
    :root{
      --nw-purple:#5A287D;
      --nw-purple-2:#6D2E9B;
      --nw-ink:#0B0F14;
      --nw-bg:#EEF1F5;
      --nw-card:#FFFFFF;
      --nw-border:#E3E7EE;
      --nw-muted:#6B7788;
      --nw-green:#1F7A4C;
      --nw-green-2:#16603B;
      --shadow:0 16px 40px rgba(11,15,20,.12);
      --shadow-soft:0 10px 25px rgba(11,15,20,.10);
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family:var(--font);
      background:#e9edf4;
      min-height:100vh;
      display:grid;
      place-items:center;
      padding:22px;
    }

    /* Phone frame */
    .phone{
      width:min(430px, 94vw);
      height:min(900px, 94vh);
      background:#0f1115;
      border-radius:40px;
      padding:14px;
      box-shadow:0 34px 90px rgba(0,0,0,.35);
      position:relative;
    }
    .screen{
      height:100%;
      border-radius:30px;
      overflow:hidden;
      background:var(--nw-bg);
      position:relative;
      display:flex;
      flex-direction:column;
    }

    /* Header */
    .header{
      padding:18px 18px 16px;
      background: linear-gradient(180deg, #0B3B8A, #0A2F6E);
      color:#fff;
      position:relative;
      box-shadow:0 10px 30px rgba(0,0,0,.22);
    }

    /* Top row: time | centered logo | secure */
    .topRow{
      display:grid;
      grid-template-columns: 1fr auto 1fr;
      align-items:center;
      gap:10px;
      margin-bottom:10px;
      font-size:12px;
      opacity:.95;
    }
    .time{
      justify-self:start;
      font-weight:900;
    }

    /* ‚úÖ TUI logo block (as requested) */
    .brand{
      justify-self:center;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .tuiLogo{
      height:28px;         /* tweak */
      width:auto;
      display:block;
    }

    .pillSecure{
      justify-self:end;
      display:inline-flex;
      align-items:center;
      gap:8px;
      background: rgba(255,255,255,.18);
      border:1px solid rgba(255,255,255,.22);
      border-radius:999px;
      padding:8px 12px;
      font-weight:900;
      font-size:12px;
      backdrop-filter: blur(8px);
    }
    .dot{
      width:10px;height:10px;border-radius:999px;
      background:#43d17b;
      box-shadow:0 0 0 3px rgba(67,209,123,.18);
    }

    .h1{
      font-size:28px;
      font-weight:1000;
      margin:6px 0 2px;
      letter-spacing:-.3px;
    }
    .sub{
      font-size:13px;
      opacity:.9;
      font-weight:800;
    }

    /* Main content */
    .content{
      flex:1;
      overflow:auto;
      padding:16px 16px 88px;
    }
    .sectionRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin:14px 2px 10px;
    }
    .sectionTitle{
      font-weight:1000;
      color: rgba(11,15,20,.60);
      font-size:14px;
    }
    .pillTag{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 12px;
      border-radius:999px;
      font-size:12px;
      font-weight:1000;
      color:#0B3B8A;
      background: rgba(11,59,138,.10);
      border:1px solid rgba(11,59,138,.14);
    }

    /* Quick actions row */
    .quickActions{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:12px;
      margin-bottom:8px;
    }
    .qa{
      background:#fff;
      border:1px solid var(--nw-border);
      border-radius:18px;
      padding:12px 10px;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:8px;
      box-shadow:0 12px 30px rgba(11,15,20,.06);
    }
    .qaIcon{
      width:34px;height:34px;border-radius:12px;
      background: rgba(11,59,138,.10);
      border:1px solid rgba(11,59,138,.14);
      display:grid;place-items:center;
      font-weight:1000;
      color: #0B3B8A;
      font-size:16px;
    }
    .qaLabel{
      font-size:12px;
      font-weight:900;
      color: rgba(11,15,20,.70);
      text-align:center;
    }

    /* Messages card */
    .msgCard{
      background:#fff;
      border:1px solid var(--nw-border);
      border-radius:22px;
      box-shadow: var(--shadow-soft);
      padding:14px;
    }
    .msgHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:10px;
    }
    .msgHeaderLeft{
      font-size:18px;
      font-weight:1000;
      color: rgba(11,15,20,.92);
    }
    .msgHeaderRight{
      font-size:13px;
      font-weight:900;
      color: rgba(11,15,20,.55);
    }

    .msgBodyRow{
      display:flex;
      gap:12px;
      align-items:flex-end;
    }
    .avatar{
      width:44px;height:44px;border-radius:16px;
      display:grid;place-items:center;
      font-weight:1000;
      color: #0B3B8A;
      background: rgba(11,59,138,.10);
      border:1px solid rgba(11,59,138,.14);
      flex:0 0 auto;
    }
    .bubble{
      flex:1;
      background: #fff;
      border:1px solid var(--nw-border);
      border-radius:22px;
      padding:14px 14px 12px;
      box-shadow:0 10px 25px rgba(11,15,20,.06);
    }
    .bubbleText{
      font-size:13.5px;
      line-height:1.35;
      color: rgba(11,15,20,.82);
    }
    .bubbleText b{
      font-weight:1000;
      color: rgba(11,15,20,.95);
    }

    .btnRow{
      display:flex;
      gap:10px;
      margin-top:12px;
      flex-wrap:wrap;
    }
    .btn{
      appearance:none;
      border:none;
      cursor:pointer;
      border-radius:16px;
      padding:12px 14px;
      font-weight:1000;
      font-size:13px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      box-shadow: 0 14px 28px rgba(11,15,20,.12);
      user-select:none;
    }
    .btn.primary{
      background: linear-gradient(180deg, #0B3B8A, #0A2F6E);
      color:#fff;
    }
    .btn.call{
      background: linear-gradient(180deg, var(--nw-green), var(--nw-green-2));
      color:#fff;
    }
    .btn.ghost{
      background:#fff;
      border:1px solid var(--nw-border);
      color: rgba(11,15,20,.82);
      box-shadow:none;
    }
    .btn:disabled{
      opacity:.6;
      cursor:not-allowed;
      box-shadow:none;
    }
    .tip{
      margin-top:12px;
      font-size:12px;
      color: rgba(11,15,20,.55);
      border-top:1px solid rgba(227,231,238,.8);
      padding-top:10px;
      line-height:1.35;
    }

    .userReplyRow{
      margin-top:14px;
      display:flex;
      justify-content:flex-end;
    }
    .userReply{
      max-width:76%;
      background: rgba(31,122,76,.10);
      border:1px solid rgba(31,122,76,.16);
      color: rgba(11,15,20,.85);
      border-radius:20px;
      padding:10px 12px;
      font-weight:900;
      font-size:13px;
      box-shadow:0 10px 25px rgba(11,15,20,.06);
    }

    /* Bottom nav */
    .nav{
      position:absolute;
      left:0;right:0;bottom:0;
      background: rgba(255,255,255,.92);
      border-top:1px solid var(--nw-border);
      padding:10px 10px 14px;
      display:flex;
      justify-content:space-around;
      z-index:10;
      backdrop-filter: blur(10px);
    }
    .navItem{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:6px;
      font-size:11px;
      font-weight:900;
      color: rgba(11,15,20,.45);
      min-width:52px;
    }
    .navItem .ico{
      width:24px;height:24px;
      display:grid;place-items:center;
      border-radius:10px;
    }
    .navItem.active{ color: #0B3B8A; }
    .navItem.active .ico{
      background: rgba(11,59,138,.12);
      border:1px solid rgba(11,59,138,.14);
      color: #0B3B8A;
    }

    /* Modals / overlays */
    .modal, .overlay{
      position:absolute;
      inset:0;
      background: rgba(11,15,20,.52);
      display:none;
      z-index:50;
      padding:12px;
    }
    .show{ display:block; }

    .sheet{
      position:absolute;
      left:12px; right:12px;
      top:88px;
      border-radius:26px;
      background:#fff;
      border:1px solid rgba(255,255,255,.65);
      box-shadow: 0 30px 90px rgba(0,0,0,.35);
      overflow:hidden;
    }
    .callSheet{
      top:68px;
      bottom:82px;
      display:flex;
      flex-direction:column;
    }
    .topBar{
      padding:14px;
      border-bottom:1px solid var(--nw-border);
      display:flex;
      justify-content:space-between;
      align-items:center;
      background: rgba(11,59,138,.06);
    }
    .topBar .h{
      font-weight:1000;
      font-size:16px;
      color: rgba(11,15,20,.92);
    }
    .sheetBody{ padding:14px; }
    .callBody{
      padding:12px;
      display:flex;
      flex-direction:column;
      gap:12px;
      overflow:auto;
      flex:1;
    }
    .webrtcMount{
      border:1px dashed rgba(11,59,138,.26);
      background: rgba(11,59,138,.04);
      border-radius:18px;
      padding:12px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      font-size:12px;
      color: rgba(11,15,20,.55);
    }
    .pill{
      border:1px solid rgba(227,231,238,.9);
      background:#fff;
      border-radius:999px;
      padding:8px 12px;
      color: rgba(11,15,20,.70);
      font-weight:1000;
      font-size:12px;
      white-space:nowrap;
    }

    /* Transcript list */
    #transcriptCard{
      display:flex;
      flex-direction:column;
      height:320px;
      min-height:260px;
    }
    .transcriptList{
      margin-top:10px;
      display:flex;
      flex-direction:column;
      gap:8px;
      overflow:auto;
      flex:1;
      padding-right:4px;
      scroll-behavior:smooth;
      min-height:0;
    }
    .tLine{
      max-width:92%;
      border-radius:14px;
      padding:10px 10px;
      font-size:12.5px;
      line-height:1.35;
      border:1px solid rgba(227,231,238,.9);
      background:#fff;
      color: rgba(11,15,20,.80);
      box-shadow:0 8px 18px rgba(11,15,20,.06);
      white-space:pre-wrap;
    }
    .tLine.bot{
      align-self:flex-start;
      background: rgba(11,59,138,.06);
      border-color: rgba(11,59,138,.16);
    }
    .tLine.user{
      align-self:flex-end;
      background: rgba(31,122,76,.10);
      border-color: rgba(31,122,76,.18);
    }
    .tMeta{
      display:block;
      font-size:10.5px;
      opacity:.75;
      margin-top:6px;
      font-weight:900;
      letter-spacing:.2px;
    }

    /* xApp iframe */
    #xappFrame{
      border:0;
      width:100%;
      height:100%;
    }

    /* Hide Cognigy launcher visually once we use our own controls */
    .hide-cognigy-launcher button[data-testid="cognigy-call-button"]{
      opacity:0 !important;
      pointer-events:none !important;
    }
  </style>
</head>

<body>
  <div class="phone">
    <div class="screen">

      <div class="header">
        <div class="topRow">
          <div class="time">11:07</div>

          <div class="brand" title="TUI">
            <img class="tuiLogo" src="https://upload.wikimedia.org/wikipedia/commons/b/bb/Tui_logo.png" alt="TUI" />
          </div>

          <div class="pillSecure"><span class="dot"></span> Secure</div>
        </div>

        <div class="h1">Hi Andy</div>
        <div class="sub">Welcome back ‚Ä¢ My TUI</div>
      </div>

      <div class="content">
        <div class="sectionRow">
          <div class="sectionTitle">Quick actions</div>
          <div style="width:18px;"></div>
        </div>

        <div class="quickActions">
          <div class="qa"><div class="qaIcon">üßæ</div><div class="qaLabel">Bookings</div></div>
          <div class="qa"><div class="qaIcon">üìç</div><div class="qaLabel">Excursions</div></div>
          <div class="qa"><div class="qaIcon">‚úàÔ∏è</div><div class="qaLabel">Flights</div></div>
          <div class="qa"><div class="qaIcon">üí¨</div><div class="qaLabel">Support</div></div>
        </div>

        <div class="sectionRow" style="margin-top:18px;">
          <div class="sectionTitle">Messages</div>
          <div class="pillTag">Proactive</div>
        </div>

        <div class="msgCard">
          <div class="msgHeader">
            <div class="msgHeaderLeft">Thea</div>
            <div class="msgHeaderRight">Just now</div>
          </div>

          <div class="msgBodyRow">
            <div class="avatar">TU</div>
            <div class="bubble">
              <div class="bubbleText">
                <strong>In-app message:</strong> Hi Andy üëã I can help with your Cancun booking for 4 (2 adults, 2 children).
                Are you looking to amend your excursion or check pickup details?
              </div>

              <div class="btnRow">
                <button class="btn primary" id="btnProjection">üßæ View bookings</button>
                <button class="btn call" id="btnCallNow">üìû Call Thea</button>
              </div>

              <div class="tip">Tip: WebRTC is preloaded (NatWest-style) so the call widget is ready when you open the call panel.</div>
            </div>
          </div>

          <div class="userReplyRow">
            <div class="userReply">I want to change the date for our snorkelling trip.</div>
          </div>
        </div>
      </div>

      <div class="nav">
        <div class="navItem active"><div class="ico">üè†</div><div>Home</div></div>
        <div class="navItem"><div class="ico">üßæ</div><div>Bookings</div></div>
        <div class="navItem"><div class="ico">üìç</div><div>Trips</div></div>
        <div class="navItem"><div class="ico">üîî</div><div>Alerts</div></div>
        <div class="navItem"><div class="ico">‚ò∞</div><div>More</div></div>
      </div>

      <!-- "Bookings" modal (kept from the NatWest pattern) -->
      <div class="modal" id="projectionModal" aria-hidden="true">
        <div class="sheet">
          <div class="topBar">
            <div class="h">Upcoming booking</div>
            <button class="btn ghost" id="btnCloseProjection">‚úï</button>
          </div>

          <div class="sheetBody">
            <div style="border:1px solid var(--nw-border); border-radius:18px; padding:12px; box-shadow:0 10px 25px rgba(11,15,20,.06);">
              <div style="font-weight:1000; margin-bottom:6px;">Canc√∫n ‚Ä¢ Family holiday</div>
              <div style="font-size:12px; color:rgba(11,15,20,.60); font-weight:900; line-height:1.35;">
                ‚Ä¢ 4 travellers (2 adults, 2 children)<br/>
                ‚Ä¢ Hotel: Riu Canc√∫n (mock)<br/>
                ‚Ä¢ Excursion: Sea Turtle &amp; Cenote Snorkelling (booked)
              </div>

              <div class="btnRow" style="margin-top:12px;">
                <button class="btn call" id="btnProjectionCall">üìû Call Thea</button>
                <button class="btn ghost" id="btnProjectionClose">Close</button>
              </div>
            </div>

            <div style="margin-top:10px; font-size:11px; color:rgba(11,15,20,.52); font-weight:900;">
              Placeholder ‚Äúbookings‚Äù panel to be replaced by your bookings xApp later.
            </div>
          </div>
        </div>
      </div>

      <!-- Call overlay -->
      <div class="overlay" id="callOverlay" aria-hidden="true">
        <div class="sheet callSheet">
          <div class="topBar">
            <div class="h">Virtual Assistant Call</div>
            <button class="btn ghost" id="btnCloseCall">‚úï</button>
          </div>

          <div class="callBody">
            <div class="webrtcMount">
              <div><b>Cognigy WebRTC</b><br><span style="font-size:11px;">In-app call controls</span></div>
              <div class="pill" id="webrtcStatus">Idle</div>
            </div>

            <div class="btnRow" style="margin:0;">
              <button class="btn call" id="btnStartCall" disabled>Start call</button>
              <button class="btn ghost" id="btnEndCall">End call</button>
              <button class="btn ghost" id="btnClearTranscript" title="Clear transcript">Clear</button>
            </div>

            <!-- Transcript -->
            <div class="msgCard" id="transcriptCard">
              <div class="msgHeader" style="margin-bottom:0;">
                <div class="msgHeaderLeft" style="font-size:14px;">Live transcription</div>
                <div class="pill" id="transcriptCount">0 lines</div>
              </div>

              <div class="transcriptList" id="transcriptList" aria-live="polite"></div>

              <div id="xappCtaArea" style="margin-top:10px; display:none;">
                <button class="btn call" id="btnOpenXapp" disabled>Click Here</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- xApp overlay -->
      <div class="overlay" id="xappOverlay" aria-hidden="true">
        <div class="sheet callSheet">
          <div class="topBar">
            <div class="h">Your options</div>
            <button class="btn ghost" id="btnCloseXapp">‚úï</button>
          </div>

          <div class="callBody" style="padding:0;">
            <iframe id="xappFrame" sandbox="allow-scripts allow-forms allow-same-origin allow-popups"></iframe>
          </div>
        </div>
      </div>

    </div>
  </div>

  <script>
    // ========= CONFIG =========
    const WIDGET_SRC = "https://static-trial.cognigy.ai/webrtc/webRTCWidget.js";

    const COGNIGY_WEBRTC_ENDPOINT_URL =
      "https://endpoint-trial.cognigy.ai/1ef4612c505f7f3d8ac3d4cc2bc0367bc702656498828b1c463ebcf466772406";

    // ===== xApp / ntfy config =====
    const NTFY_TOPIC = "tui-xapp-demo-CHANGE-ME";
    const XAPP_TRIGGER_PHRASE_1 = "Click here to manage your excursion booking.";
    const XAPP_TRIGGER_PHRASE_2 = "Click here to confirm the changes to your booking.";
    const FALLBACK_XAPP_URL = "https://example.com";

    let latestXappUrl = null;
    let latestXappStep = null;
    let pendingXappStep = null;
    let lastConsumedXappStep = null;

    // ========= HELPERS =========
    const byId = (id) => document.getElementById(id);
    const show = (el) => el && el.classList.add("show");
    const hide = (el) => el && el.classList.remove("show");
    const setStatus = (t) => { const el = byId("webrtcStatus"); if (el) el.textContent = t; };

    function isVisible(el){
      if (!el) return false;
      const r = el.getBoundingClientRect();
      return r.width > 0 && r.height > 0 && getComputedStyle(el).visibility !== "hidden";
    }

    // ========= xApp UI =========
    function showXappCta(step){
      const area = byId("xappCtaArea");
      if (!area) return;

      pendingXappStep = step;
      if (pendingXappStep !== null && pendingXappStep === lastConsumedXappStep) return;

      area.style.display = "block";
      updateXappCtaButton();
    }

    function hideXappCta(){
      const area = byId("xappCtaArea");
      if (!area) return;
      area.style.display = "none";
    }

    function getUrlForPendingStep(){
      if (pendingXappStep != null) {
        if (latestXappUrl && latestXappStep != null && Number(latestXappStep) === Number(pendingXappStep)) {
          return latestXappUrl;
        }
        return null;
      }
      return latestXappUrl || FALLBACK_XAPP_URL;
    }

    function updateXappCtaButton(){
      const btn = byId("btnOpenXapp");
      if (!btn) return;

      const url = getUrlForPendingStep() || (pendingXappStep == null ? FALLBACK_XAPP_URL : null);
      if (url){
        btn.disabled = false;
        btn.textContent = "Click Here";
      } else {
        btn.disabled = true;
        btn.textContent = "Loading link‚Ä¶";
      }
    }

    function openXappInApp(url){
      const overlay = byId("xappOverlay");
      const frame = byId("xappFrame");
      if (!overlay || !frame) return;
      frame.src = url;
      show(overlay);
    }

    function closeXapp(){
      const frame = byId("xappFrame");
      if (frame) frame.src = "about:blank";
      hide(byId("xappOverlay"));
    }

    // ========= NTFY SUBSCRIBE (SSE) =========
    function subscribeToNtfy(){
      if (!NTFY_TOPIC || NTFY_TOPIC.includes("CHANGE-ME")) return;
      const url = `https://ntfy.sh/${NTFY_TOPIC}/sse`;
      const es = new EventSource(url);

      es.onmessage = (ev) => {
        try{
          const envelope = JSON.parse(ev.data);
          const msg = envelope.message;
          if (!msg) return;

          const payload = JSON.parse(msg);
          if (payload?.type !== "xapp") return;

          if (typeof payload.url === "string" && payload.url.trim()){
            latestXappUrl = payload.url.trim();
            latestXappStep = payload.step ?? null;
            updateXappCtaButton();
            console.log("xApp URL updated:", latestXappUrl, "step:", latestXappStep);
          }
        } catch {}
      };

      es.onerror = () => console.warn("ntfy SSE disconnected (will retry)...");
      window.__ntfy = es;
    }

    // ========= TRANSCRIPT UI (ROBUST MERGE) =========
    const VA_NAME = "Thea";
    const USER_NAME = "Andy Martin";

    // Treat bot utterance as "ended" after this long with no bot text
    const BOT_END_SILENCE_MS = 2200;

    let transcriptLines = 0;

    const mergeState = {
      lastRole: null,              // "bot" | "user"
      lastEl: null,
      lastText: "",
      botSilenceTimer: null,
      lastUserAt: 0
    };

    function updateTranscriptCount(){
      const el = byId("transcriptCount");
      if (!el) return;
      el.textContent = `${transcriptLines} ${transcriptLines === 1 ? "line" : "lines"}`;
    }

    function isPinnedToBottom(list, thresholdPx = 28){
      const distanceFromBottom = list.scrollHeight - list.scrollTop - list.clientHeight;
      return distanceFromBottom < thresholdPx;
    }

    function scrollToBottom(list){
      requestAnimationFrame(() => { list.scrollTop = list.scrollHeight; });
    }

    function normalizeText(s){
      return String(s || "")
        .replace(/\s+/g, " ")
        .replace(/\s([,.;!?])/g, "$1")
        .trim();
    }

    function endBotTurn(){
      if (mergeState.botSilenceTimer) clearTimeout(mergeState.botSilenceTimer);
      mergeState.botSilenceTimer = null;
      // Mark that next bot chunk should start a new bubble
      if (mergeState.lastRole === "bot") {
        mergeState.lastRole = null;
        mergeState.lastEl = null;
        mergeState.lastText = "";
      }
    }

    function scheduleBotTurnEnd(){
      if (mergeState.botSilenceTimer) clearTimeout(mergeState.botSilenceTimer);
      mergeState.botSilenceTimer = setTimeout(endBotTurn, BOT_END_SILENCE_MS);
    }

    function addTranscriptLine(originator, text){
      const list = byId("transcriptList");
      if (!list) return;

      const who = (originator || "unknown").toLowerCase();
      const isUser = (who === "user");
      const role = isUser ? "user" : "bot";

      const chunk = normalizeText(text);
      if (!chunk) return;

      const pinned = isPinnedToBottom(list);

      // If user speaks, we always start a new user bubble
      if (isUser) {
        mergeState.lastRole = null;
        mergeState.lastEl = null;
        mergeState.lastText = "";
        mergeState.lastUserAt = Date.now();
        if (mergeState.botSilenceTimer) clearTimeout(mergeState.botSilenceTimer);
        mergeState.botSilenceTimer = null;
      }

      // BOT MERGE RULE:
      // - if last bubble is bot, keep appending until user speaks OR bot silence timer expires
      const canMerge =
        role === "bot" &&
        mergeState.lastRole === "bot" &&
        mergeState.lastEl;

      if (canMerge) {
        mergeState.lastText = (mergeState.lastText ? (mergeState.lastText + " " + chunk) : chunk).trim();

        const meta = mergeState.lastEl.querySelector(".tMeta");
        mergeState.lastEl.textContent = mergeState.lastText;
        if (meta) mergeState.lastEl.appendChild(meta);

        scheduleBotTurnEnd();
      } else {
        const line = document.createElement("div");
        line.className = `tLine ${role}`;
        line.textContent = chunk;

        const meta = document.createElement("span");
        meta.className = "tMeta";
        meta.textContent = role === "user" ? USER_NAME : VA_NAME;
        line.appendChild(meta);

        list.appendChild(line);
        transcriptLines += 1;
        updateTranscriptCount();

        mergeState.lastRole = role;
        mergeState.lastEl = line;
        mergeState.lastText = chunk;

        if (role === "bot") scheduleBotTurnEnd();
      }

      if (pinned) scrollToBottom(list);

      // Trigger phrases (check merged bot text)
      if (role === "bot") {
        const merged = mergeState.lastText || chunk;
        if (merged.includes(XAPP_TRIGGER_PHRASE_1)) showXappCta(1);
        else if (merged.includes(XAPP_TRIGGER_PHRASE_2)) showXappCta(2);
      }
    }

    function clearTranscript(){
      const list = byId("transcriptList");
      if (list) list.innerHTML = "";
      transcriptLines = 0;
      updateTranscriptCount();

      pendingXappStep = null;
      lastConsumedXappStep = null;
      hideXappCta();
      updateXappCtaButton();

      if (mergeState.botSilenceTimer) clearTimeout(mergeState.botSilenceTimer);
      mergeState.lastRole = null;
      mergeState.lastEl = null;
      mergeState.lastText = "";
      mergeState.botSilenceTimer = null;
    }

    // ========= WEBSOCKET TAP (captures SIP INFO frames with JSON _transcription) =========
    function installWebSocketTranscriptionTap(){
      if (window.__wsTapInstalled) return;
      window.__wsTapInstalled = true;

      const NativeWebSocket = window.WebSocket;

      window.WebSocket = function(...args){
        const ws = new NativeWebSocket(...args);

        ws.addEventListener("message", (ev) => {
          const data = ev.data;
          if (typeof data !== "string") return;
          if (!data.includes('"_transcription"')) return;

          const splitIndex = data.indexOf("\r\n\r\n");
          if (splitIndex === -1) return;

          const body = data.slice(splitIndex + 4).trim();
          if (!body.startsWith("{")) return;

          try{
            const json = JSON.parse(body);
            const t = json?._transcription;
            if (!t) return;

            const originator = t.originator || "unknown";
            const messages = Array.isArray(t.messages) ? t.messages : [];
            for (const m of messages){
              if (m && typeof m.text === "string" && m.text.trim()){
                addTranscriptLine(originator, m.text.trim());
              }
            }
          } catch {}
        });

        return ws;
      };

      window.WebSocket.prototype = NativeWebSocket.prototype;
      window.WebSocket.OPEN = NativeWebSocket.OPEN;
      window.WebSocket.CLOSED = NativeWebSocket.CLOSED;
      window.WebSocket.CLOSING = NativeWebSocket.CLOSING;
      window.WebSocket.CONNECTING = NativeWebSocket.CONNECTING;
    }

    installWebSocketTranscriptionTap();

    // ========= WIDGET LOADER / INIT =========
    let widgetScriptLoaded = false;
    let widgetInitialized = false;
    let preloadStarted = false;

    function loadScript(timeoutMs = 12000){
      return new Promise((resolve, reject) => {
        if (widgetScriptLoaded) return resolve("already-loaded");
        widgetScriptLoaded = true;

        const s = document.createElement("script");
        s.src = WIDGET_SRC;
        s.async = true;

        let done = false;
        const ok = (how) => { if (done) return; done = true; resolve(how); };
        const fail = (how) => {
          if (done) return;
          done = true;
          widgetScriptLoaded = false;
          reject(new Error(how));
        };

        const t = setTimeout(() => fail("timeout"), timeoutMs);
        s.onload = () => { clearTimeout(t); ok("onload"); };
        s.onerror = () => { clearTimeout(t); fail("onerror"); };

        document.head.appendChild(s);
      });
    }

    async function initWebRTC(){
      if (widgetInitialized) return true;

      try{
        setStatus("Loading‚Ä¶");
        await loadScript(12000);

        if (typeof window.initWebRTCWidget !== "function") {
          setStatus("Unavailable");
          return false;
        }

        setStatus("Initializing‚Ä¶");
        window.initWebRTCWidget(COGNIGY_WEBRTC_ENDPOINT_URL);

        widgetInitialized = true;
        setStatus("Ready");
        return true;
      } catch {
        setStatus("Load failed");
        return false;
      }
    }

    // ========= Start/End button discovery =========
    function findCognigyStartButton(){
      return (
        document.querySelector('button[data-testid="cognigy-call-button"]') ||
        document.querySelector('button[aria-label="Start a call"]') ||
        document.querySelector('.webrtc_widget_content_call_button')
      );
    }

    function findCognigyEndButton(){
      return (
        document.querySelector('button[data-testid*="hang" i]') ||
        document.querySelector('button[data-testid*="end" i]') ||
        document.querySelector('button[aria-label*="hang" i]') ||
        document.querySelector('button[aria-label*="end" i]') ||
        document.querySelector('button[title*="hang" i]') ||
        document.querySelector('button[title*="end" i]') ||
        document.querySelector('button[class*="hang" i]') ||
        document.querySelector('button[class*="end" i]')
      );
    }

    function waitForStartButton(timeoutMs = 10000){
      return new Promise((resolve) => {
        const immediate = findCognigyStartButton();
        if (immediate) return resolve(immediate);

        const obs = new MutationObserver(() => {
          const btn = findCognigyStartButton();
          if (btn) { obs.disconnect(); resolve(btn); }
        });
        obs.observe(document.documentElement, { childList:true, subtree:true });

        setTimeout(() => { obs.disconnect(); resolve(null); }, timeoutMs);
      });
    }

    async function preloadForCallUI(){
      if (preloadStarted) return;
      preloadStarted = true;

      const ok = await initWebRTC();
      if (!ok) return;

      const btn = await waitForStartButton(10000);
      if (btn) {
        byId("btnStartCall").disabled = false;
        document.documentElement.classList.add("hide-cognigy-launcher");
        setStatus("Ready");
      } else {
        setStatus("Not ready");
      }
    }

    function startCallSync(){
      const btn = findCognigyStartButton();
      if (!btn) return false;
      btn.click();
      document.documentElement.classList.add("hide-cognigy-launcher");
      setStatus("Calling‚Ä¶");
      return true;
    }

    async function endCall(){
      try {
        const api = window.webRTCWidget || window.webrtcWidget || null;
        if (api && typeof api.endCall === "function") {
          await api.endCall();
          setStatus("Ended");
          return true;
        }
      } catch {}

      const endBtn = findCognigyEndButton();
      if (endBtn && isVisible(endBtn)) {
        endBtn.click();
        setStatus("Ended");
        return true;
      }

      setStatus("End unavailable");
      return false;
    }

    // ========= UI wiring =========
    document.addEventListener("DOMContentLoaded", () => {
      // Start listening for xApp updates immediately (optional)
      subscribeToNtfy();

      // ‚úÖ NatWest-style behaviour: preload WebRTC on page load
      preloadForCallUI();

      // Bookings modal
      byId("btnProjection").addEventListener("click", () => show(byId("projectionModal")));
      byId("btnCloseProjection").addEventListener("click", () => hide(byId("projectionModal")));
      byId("btnProjectionClose").addEventListener("click", () => hide(byId("projectionModal")));
      byId("projectionModal").addEventListener("click", (e) => {
        if (e.target === byId("projectionModal")) hide(byId("projectionModal"));
      });

      // Bookings -> Call Now
      byId("btnProjectionCall").addEventListener("click", () => {
        hide(byId("projectionModal"));
        show(byId("callOverlay"));
        preloadForCallUI();
      });

      // Call open/close
      byId("btnCallNow").addEventListener("click", () => {
        show(byId("callOverlay"));
        preloadForCallUI();
      });
      byId("btnCloseCall").addEventListener("click", () => hide(byId("callOverlay")));
      byId("callOverlay").addEventListener("click", (e) => {
        if (e.target === byId("callOverlay")) hide(byId("callOverlay"));
      });

      // Call controls
      byId("btnStartCall").addEventListener("click", () => {
        const ok = startCallSync();
        if (!ok) setStatus("Not ready");
      });

      byId("btnEndCall").addEventListener("click", async () => {
        setStatus("Ending‚Ä¶");
        await endCall();
      });

      byId("btnClearTranscript").addEventListener("click", () => clearTranscript());

      // xApp CTA click
      byId("btnOpenXapp").addEventListener("click", () => {
        const url = getUrlForPendingStep() || (pendingXappStep == null ? FALLBACK_XAPP_URL : null);
        if (!url) return;

        if (pendingXappStep !== null) lastConsumedXappStep = pendingXappStep;

        hideXappCta();
        updateXappCtaButton();
        openXappInApp(url);
      });

      // xApp overlay close
      byId("btnCloseXapp").addEventListener("click", () => closeXapp());
      byId("xappOverlay").addEventListener("click", (e) => {
        if (e.target === byId("xappOverlay")) closeXapp();
      });

      setStatus("Idle");
      updateTranscriptCount();
      updateXappCtaButton();
    });
  </script>
</body>
</html>
